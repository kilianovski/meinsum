(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{23720:function(e,t,n){Promise.resolve().then(n.bind(n,36276))},36276:function(e,t,n){"use strict";n.r(t),n.d(t,{LayerView:function(){return ns}});var r,o,i,a,l,s,c,u,d,f,h,m,p,x,g,v,y,_,b,w,A,E,T,z,R,B,M,D,F,I,P,k,S,C,L,U,O,N,X,j,V=n(57437),Y=n(2265);function G(e){return null!=e}function q(e,t,n,r,o){if(o&&o.length!==r.length)throw Error("Number of texture names (".concat(o.length,") does not match number of src textures (").concat(r.length,")"));let i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);for(let t=0;t<n.length;t++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,n[t].texture,0);e.drawBuffers(n.map((t,n)=>e.COLOR_ATTACHMENT0+n));let a=e.checkFramebufferStatus(e.FRAMEBUFFER);return a!==e.FRAMEBUFFER_COMPLETE&&console.log("createRenderPhase: framebuffer not complete: "+a),{destBuffers:n,srcBuffers:r,fbo:i,program:t,uniformNames:o,uniformsSet:!1}}function W(e,t,n,r){let o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o);let[i,a]=Q(e,r);return e.texImage2D(e.TEXTURE_2D,0,a,t,n,0,i,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),{width:t,height:n,texture:o,channels:r}}function H(e,t,n){if(n.length!==t.width*t.height*t.channels)throw Error("Data length does not match buffer size");e.bindTexture(e.TEXTURE_2D,t.texture);let[r]=Q(e,t.channels);e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.width,t.height,r,e.FLOAT,n)}function Q(e,t){switch(t){case 1:return[e.RED,e.R32F];case 2:return[e.RG,e.RG32F];case 3:return[e.RGB,e.RGB32F];case 4:return[e.RGBA,e.RGBA32F];default:throw Error("Invalid number of channels: ".concat(t,". Must be 1, 2, 3, or 4."))}}(r=A||(A={}))[r.RED=6403]="RED",r[r.RG=33319]="RG",r[r.RGB=6407]="RGB",r[r.RGBA=6408]="RGBA",(o=E||(E={}))[o.R32F=33326]="R32F",o[o.RG32F=33328]="RG32F",o[o.RGB32F=34837]="RGB32F",o[o.RGBA32F=34836]="RGBA32F",(i=T||(T={}))[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.FLOAT=5126]="FLOAT",(a=z||(z={}))[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z";class K{add(e){return new K(this.x+e.x,this.y+e.y,this.z+e.z)}sub(e){return new K(this.x-e.x,this.y-e.y,this.z-e.z)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}mul(e){return new K(this.x*e,this.y*e,this.z*e)}mulAdd(e,t){return new K(this.x+e.x*t,this.y+e.y*t,this.z+e.z*t)}lenSq(){return this.x*this.x+this.y*this.y+this.z*this.z}distSq(e){let t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r}len(){return Math.sqrt(this.lenSq())}dist(e){return Math.sqrt(this.distSq(e))}normalize(){return this.mul(1/Math.sqrt(this.lenSq()))}mid(e){return new K((this.x+e.x)*.5,(this.y+e.y)*.5,(this.z+e.z)*.5)}abs(){return new K(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}clone(){return new K(this.x,this.y,this.z)}toVec4(){return new Z(this.x,this.y,this.z,1)}round(){return new K(Math.round(this.x),Math.round(this.y),Math.round(this.z))}round_(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}copy_(e){this.x=e.x,this.y=e.y,this.z=e.z}static cross(e,t){return new K(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}writeToBuf(e,t){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}static fromArray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new K(e[t+0],e[t+1],e[t+2])}setAt(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t}return this}addAt(e,t){switch(e){case 0:this.x+=t;break;case 1:this.y+=t;break;case 2:this.z+=t}return this}getAt(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z}return 0}withSetAt(e,t){return this.clone().setAt(e,t)}withAddAt(e,t){return this.clone().addAt(e,t)}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;return"Vec3(".concat(J(this.x,e),", ").concat(J(this.y,e),", ").concat(J(this.z,e),")")}rotateAbout(e,t){let n=Math.cos(t),r=Math.sin(t),o=K.cross(e,this),i=e.dot(this);return this.mul(n).add(o.mul(r)).add(e.mul(i*(1-n)))}lerp(e,t){return new K(e.x*t+this.x*(1-t),e.y*t+this.y*(1-t),e.z*t+this.z*(1-t))}constructor(e=0,t=0,n=0){this.x=+e,this.y=+t,this.z=+n}}K.zero=new K(0,0,0),K.one=new K(1,1,1);class Z{getIdx(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("Invalid index ".concat(e))}}add(e){return new Z(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}sub(e){return new Z(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w+e.w}mul(e){return new Z(this.x*e,this.y*e,this.z*e,this.w*e)}lenSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}distSq(e){let t=this.x-e.x,n=this.y-e.y,r=this.z-e.z,o=this.w-e.w;return t*t+n*n+r*r+o*o}len(){return Math.sqrt(this.lenSq())}dist(e){return Math.sqrt(this.distSq(e))}normalize(){return this.mul(1/Math.sqrt(this.lenSq()))}projToVec3(){return new K(this.x/this.w,this.y/this.w,this.z/this.w)}static lerp(e,t,n){return e.add(t.sub(e).mul(n))}writeToBuf(e,t){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}static fromArray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Z(e[t+0],e[t+1],e[t+2],e[t+3])}static fromVec3(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new Z(e.x,e.y,e.z,t)}toArray(){return[this.x,this.y,this.z,this.w]}static fromHexColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e.startsWith("#")&&(e=e.slice(1));let n=parseInt(e,16);return new Z((n>>16&255)/255*t,(n>>8&255)/255*t,(255&n)/255*t,t)}toHexColor(){let e=e=>Math.floor(255*e).toString(16).padStart(2,"0");return"#".concat(e(this.x)).concat(e(this.y)).concat(e(this.z)).concat(e(this.w))}toString(){return"Vec4(".concat(J(this.x),", ").concat(J(this.y),", ").concat(J(this.z),", ").concat(J(this.w),")")}constructor(e=0,t=0,n=0,r=1){this.x=+e,this.y=+t,this.z=+n,this.w=+r}}function J(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return parseFloat(e.toFixed(t)).toString()}class ${addInPlace(e){return this.empty?(this.min.x=e.x,this.min.y=e.y,this.min.z=e.z,this.max.x=e.x,this.max.y=e.y,this.max.z=e.z,this.empty=!1):(this.min.x=Math.min(this.min.x,e.x),this.min.y=Math.min(this.min.y,e.y),this.min.z=Math.min(this.min.z,e.z),this.max.x=Math.max(this.max.x,e.x),this.max.y=Math.max(this.max.y,e.y),this.max.z=Math.max(this.max.z,e.z)),this}combineInPlace(e){return e.empty?this:this.addInPlace(e.min).addInPlace(e.max)}center(){let e=this.max,t=this.min;return new K(e.x+.5*(t.x-e.x),e.y+.5*(t.y-e.y),e.z+.5*(t.z-e.z))}size(){return this.max.sub(this.min)}contains(e){return!this.empty&&e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}intersects(e){return!this.empty&&!e.empty&&this.max.x>=e.min.x&&this.min.x<=e.max.x&&this.max.y>=e.min.y&&this.min.y<=e.max.y&&this.max.z>=e.min.z&&this.min.z<=e.max.z}expandInPlace(e){return this.empty||(this.min.x-=e,this.min.y-=e,this.min.z-=e,this.max.x+=e,this.max.y+=e,this.max.z+=e),this}shrinkInPlaceXY(e){return!this.empty&&(this.min.x+=e,this.min.y+=e,this.max.x-=e,this.max.y-=e,(this.min.x>this.max.x||this.min.y>this.max.y)&&(this.empty=!0,this.min=new K,this.max=new K)),this}clone(){let e=new $;return e.min=this.min.clone(),e.max=this.max.clone(),e.empty=this.empty,e}toString(){return"BoundingBox3d(".concat(this.min,", ").concat(this.max,")")}constructor(...e){for(let t of(this.min=new K,this.max=new K,this.empty=!0,e))this.addInPlace(t)}}class ee{static add_(e,t,n,r,o,i){o[i+0]=e[t+0]+n[r+0],o[i+1]=e[t+1]+n[r+1],o[i+2]=e[t+2]+n[r+2]}static sub_(e,t,n,r,o,i){o[i+0]=e[t+0]-n[r+0],o[i+1]=e[t+1]-n[r+1],o[i+2]=e[t+2]-n[r+2]}static copy_(e,t,n,r){n[r+0]=e[t+0],n[r+1]=e[t+1],n[r+2]=e[t+2]}static normalize_(e,t,n,r){let o=e[t+0],i=e[t+1],a=e[t+2],l=1/Math.sqrt(o*o+i*i+a*a);n[r+0]=o*l,n[r+1]=i*l,n[r+2]=a*l}static len_(e,t){let n=e[t+0],r=e[t+1],o=e[t+2];return Math.sqrt(n*n+r*r+o*o)}}function et(e){return null==e}function en(e){return null!=e}function er(e,t,n){return e<t?t:e>n?n:e}function eo(e){let t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}function ei(e,t,n){return e+(t-e)*er(n,0,1)}function ea(e,t,n){return n<=0?e:n>=1?t:e+(t-e)*n*n*(3-2*n)}function el(e,t,n,r,o,i){var a;"shaderManager"in e&&(e=e.shaderManager);let l=e.gl,s=l.createProgram();function c(e,t,n,r){let o=r.get(t);return o||(o=l.createShader(e),l.shaderSource(o,t),l.compileShader(o),r.set(t,o)),l.attachShader(s,o),o}let u=c(l.VERTEX_SHADER,n,"vert",e.vertShaders),d=c(l.FRAGMENT_SHADER,r,"frag",e.fragShaders),f={};if(o)for(let e of o)f[e]=-1;let h={name:t,program:s,vertSource:n,fragSource:r,vertShader:u,fragShader:d,locs:f,uboBindings:null!==(a=null==i?void 0:i.uboBindings)&&void 0!==a?a:{},ready:!1};return e.unlinkedPrograms.push(h),h}function es(e){let t=e.gl;for(let n of e.unlinkedPrograms)t.linkProgram(n.program);for(let o of e.unlinkedPrograms){let e=o.program;if(t.getProgramParameter(e,t.LINK_STATUS)){for(let n of Object.keys(o.locs)){let r=t.getUniformLocation(e,n);r||console.log("uniform of ".concat(o.name," not found: ").concat(n," (may just be unused)")),o.locs[n]=r}for(let n of(o.ready=!0,Object.keys(o.uboBindings))){let r=t.getUniformBlockIndex(e,n);r<0&&console.log("ubo of ".concat(o.name," not found: ").concat(n," (may just be unused)")),t.uniformBlockBinding(e,r,o.uboBindings[n])}}else{if(t.getProgramInfoLog(e)){var n;let r="---- '".concat(o.name,"' program info log ----");console.log("".concat(r,"\n")+(null===(n=t.getProgramInfoLog(e))||void 0===n?void 0:n.replace("\x00","").trimEnd()))}r(o.vertShader,o.name,"vert"),r(o.fragShader,o.name,"frag")}}function r(e,n,r){let o=t.getShaderInfoLog(e);if(o){let e="---- ".concat(n," ").concat(r," shader info log ----");console.log("".concat(e,"\n")+o.replace("\x00","").trimEnd())}}e.programs.push(...e.unlinkedPrograms),e.unlinkedPrograms=[]}function ec(e,t,n,r){var o,i;e.bindBuffer(e.ARRAY_BUFFER,t);let a=n.locOffset||0,l=n.bufOffset||0,s=n.divisor||0,c=0;for(let e of r)c+=4*e.size*(null!==(o=e.nCols)&&void 0!==o?o:1);for(let t of r)for(let n=0;n<(null!==(i=t.nCols)&&void 0!==i?i:1);n++)e.enableVertexAttribArray(a),e.vertexAttribPointer(a,t.size,e.FLOAT,!1,c,l),e.vertexAttribDivisor(a,s),l+=4*t.size,a++;return c}function eu(e,t,n,r,o,i){let a=(null==i?void 0:i.numPhases)||1;if(t===e.UNIFORM_BUFFER){var l;o=Math.ceil(o/(l=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)))*l}let s=o/4;e.bindBuffer(t,n),e.bufferData(t,r*o,e.DYNAMIC_DRAW);let c=[];for(let e=0;e<a;e++)c.push({buf:new Float32Array(r*s),strideFloats:s,strideBytes:o,capacityEls:r,usedEls:0,glOffsetEls:0});return{target:t,buf:n,strideFloats:s,strideBytes:o,glCapacityEls:r,localBufs:c}}function ed(e,t){let n=e.usedEls+t;if(n>e.capacityEls){for(;n>e.capacityEls;)e.capacityEls*=2;let t=new Float32Array(e.capacityEls*e.strideFloats);t.set(e.buf),e.buf=t}}function ef(e,t){e.bindBuffer(t.target,t.buf);let n=0;for(let e=0;e<t.localBufs.length;e++)n+=t.localBufs[e].usedEls;if(n>t.glCapacityEls){for(;n>t.glCapacityEls;)t.glCapacityEls*=2;e.bufferData(t.target,t.glCapacityEls*t.strideBytes,e.DYNAMIC_DRAW)}let r=0;for(let n=0;n<t.localBufs.length;n++){let o=t.localBufs[n];o.glOffsetEls=r,o.usedEls>0&&e.bufferSubData(t.target,r*t.strideBytes,o.buf.subarray(0,o.usedEls*o.strideFloats)),r+=o.usedEls}}function eh(e){for(let t=0;t<e.localBufs.length;t++)e.localBufs[t].usedEls=0}function em(e,t,n,r){let o=(null==r?void 0:r.numPhases)||1;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,4*n,e.DYNAMIC_DRAW);let i=[];for(let e=0;e<o;e++)i.push({buf:new Uint32Array(n),capacityVerts:n,usedVerts:0,glOffsetBytes:0});return{buf:t,glCapacityVerts:n,localBufs:i}}function ep(e,t){let n=e.usedVerts+t;if(n>e.capacityVerts){let t=2*e.capacityVerts;for(;n>t;)t*=2;let r=new Uint32Array(t);r.set(e.buf),e.capacityVerts=t,e.buf=r}}function ex(e,t){e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.buf);let n=0;for(let e=0;e<t.localBufs.length;e++)n+=t.localBufs[e].usedVerts;if(n>t.glCapacityVerts){for(;n>t.glCapacityVerts;)t.glCapacityVerts*=2;e.bufferData(e.ELEMENT_ARRAY_BUFFER,4*t.glCapacityVerts,e.DYNAMIC_DRAW)}let r=0;for(let n=0;n<t.localBufs.length;n++){let o=t.localBufs[n];o.glOffsetBytes=4*r;let i=o.buf.subarray(0,o.usedVerts);o.usedVerts>0&&e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,4*r,i),r+=o.usedVerts}}function eg(e){for(let t=0;t<e.localBufs.length;t++)e.localBufs[t].usedVerts=0}let ev="#version 300 es\nprecision highp float;\nlayout(location = 0) in vec2 a_position;\nvoid main() {\n    gl_Position = vec4(a_position, 0, 1);\n}\n";function ey(e,t,n){let{gl:r,model:o,shape:{B:i,T:a,C:l},shaderManager:s}=e,c=o[t+".weight"],u=o[t+".bias"],d=W(r,1,l,1),f=W(r,1,l,1),h=W(r,1,i*a,2),m=W(r,l,i*a,1);H(r,d,c.toFloat32Array()),H(r,f,u.toFloat32Array());let p=el(s,"normAgg",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D normInput; // (B, T) (C)\n        out vec2 normAgg;            // (B, T) (1) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            // Use Welford's algorithm to compute mean and variance\n            float mean = 0.0;\n            float M2 = 0.0;\n            for (int i = 0; i < ".concat(l,"; i++) {\n                float x = texelFetch(normInput, ivec2(i, pos.y), 0).r;\n                float delta = x - mean;\n                mean += delta / float(i + 1);\n                M2 += delta * (x - mean);\n            }\n\n            normAgg = vec2(mean, 1.0 / sqrt(M2 / float(").concat(l,") + ").concat(1e-5,"));\n        }\n    ")),x=el(s,"normApply",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D normInput;  // (B, T) (C)\n        uniform sampler2D normAgg;    // (B, T) (1) [2]\n        uniform sampler2D normWeight; // (C)    (1)\n        uniform sampler2D normBias;   // (C)    (1)\n        out float normOutput;         // (B, T) (C)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            vec2 agg = texelFetch(normAgg, ivec2(0, pos.y), 0).rg;\n            float mean = agg.r;\n            float stdInv = agg.g;\n\n            float x = texelFetch(normInput, pos, 0).r;\n\n            float weight = texelFetch(normWeight, ivec2(0, pos.x), 0).r;\n            float bias   = texelFetch(normBias,   ivec2(0, pos.x), 0).r;\n\n            normOutput = (x - mean) * stdInv * weight + bias;\n        }\n    ");return{normAgg:h,normWeight:d,normBias:f,aggPhase:q(r,p,[h],[n],["normInput"]),applyPhase:q(r,x,[m],[n,h,d,f],["normInput","normAgg","normWeight","normBias"]),output:m}}function e_(e,t,n,r,o,i,a){let{gl:l,model:s,shape:{B:c,T:u},shaderManager:d}=e;a=null==a||a;let f=s[t+".weight"],h=a?s[t+".bias"]:null,m=W(l,n,r,1),p=a?W(l,1,r,1):null,x=W(l,r,c*u,1);H(l,m,f.buffer),h&&p&&H(l,p,h.buffer);let g=q(l,el(d,"linear",ev,"#version 300 es\n        precision highp float;          //    y     x\n        uniform sampler2D linearInput;  // (B, T) (nIn)\n        uniform sampler2D linearWeight; // (nOut) (nIn)\n        ".concat(a?"uniform sampler2D linearBias;":"","   // (nOut) (1)\n        ").concat(i?"uniform sampler2D linearResidual;":"","\n        out float linearOutput;         // (B, T) (nOut)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            float res = ").concat(a?"texelFetch(linearBias, ivec2(0, pos.x), 0).r":"0.0",";\n            for (int i = 0; i < ").concat(n,"; i++) {\n                float x = texelFetch(linearInput, ivec2(i, pos.y), 0).r;\n                float w = texelFetch(linearWeight, ivec2(i, pos.x), 0).r;\n                res += x * w;\n            }\n\n            ").concat(i?"res += texelFetch(linearResidual, pos, 0).r;":"","\n            linearOutput = res;\n        }\n    ")),[x],[o,m,p,i].filter(G),["linearInput","linearWeight",a?"linearBias":null,i?"linearResidual":null].filter(G));return{weight:m,bias:p,linearPhase:g,output:x}}function eb(e,t,n,r,o){let{gl:i,model:a,shape:{B:l,T:s},shaderManager:c}=e,u=a[t+".weight"],d=W(i,r,n,1),f=W(i,r,l*s,1);return H(i,d,u.buffer),{weight:d,phase:q(i,el(c,"embed",ev,"#version 300 es\n        precision highp float;          //    y     x\n        uniform sampler2D embedInput;  // (B, T)   (1)\n        uniform sampler2D embedWeight; // (nEmbed) (nDims)\n        out float embedOutput;         // (B, T)   (nDims)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int y = int(texelFetch(embedInput, ivec2(0, pos.y), 0).r);\n            float res = texelFetch(embedWeight, ivec2(pos.x, y), 0).r;\n\n            embedOutput = res;\n        }\n    "),[f],[o,d],["embedInput","embedWeight"]),output:f}}function ew(e,t,n){let{gl:r,shape:{B:o,T:i,C:a},shaderManager:l}=e,s=W(r,a,o*i,1);return{addPhase:q(r,el(l,"add",ev,"#version 300 es\n        precision highp float;     //    y    x\n        uniform sampler2D inputA;  // (B, T) (C)\n        uniform sampler2D inputB;  // (B, T) (C)\n        out float addOutput;       // (B, T) (C)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            float a = texelFetch(inputA, pos, 0).r;\n            float b = texelFetch(inputB, pos, 0).r;\n            addOutput = a + b;\n        }\n    "),[s],[t,n],["inputA","inputB"]),output:s}}var eA=n(8248),eE=n.n(eA);class eT extends Float32Array{g(e,t){return this[4*t+e]}s(e,t,n){this[4*t+e]=n}add(e){let t=new eT;for(let n=0;n<16;n++)t[n]=this[n]+e[n];return t}sub(e){let t=new eT;for(let n=0;n<16;n++)t[n]=this[n]-e[n];return t}mul(e){let t=new eT;for(let n=0;n<4;n++)for(let r=0;r<4;r++){let o=0;for(let t=0;t<4;t++)o+=this[4*t+r]*e[4*n+t];t[4*n+r]=o}return t}mulVec4(e){let t=this[0]*e.x+this[4]*e.y+this[8]*e.z+this[12]*e.w,n=this[1]*e.x+this[5]*e.y+this[9]*e.z+this[13]*e.w,r=this[2]*e.x+this[6]*e.y+this[10]*e.z+this[14]*e.w,o=this[3]*e.x+this[7]*e.y+this[11]*e.z+this[15]*e.w;return new Z(t,n,r,o)}mulVec3Proj(e){let t=this.mulVec4(new Z(e.x,e.y,e.z,1)),n=1/t.w;return new K(t.x*n,t.y*n,t.z*n)}mulVec3ProjVec(e){let t=this.mulVec4(new Z(e.x,e.y,e.z,0));return new K(t.x,t.y,t.z)}mulVec3Affine(e){let t=new K;return this.mulVec3Affine_(e,t),t}mulVec3Affine_(e,t){let n=this[0]*e.x+this[4]*e.y+this[8]*e.z+this[12],r=this[1]*e.x+this[5]*e.y+this[9]*e.z+this[13],o=this[2]*e.x+this[6]*e.y+this[10]*e.z+this[14];t.x=n,t.y=r,t.z=o}mulVec3AffineArr_(e,t,n,r){let o=e[t],i=e[t+1],a=e[t+2];n[r+0]=this[0]*o+this[4]*i+this[8]*a+this[12],n[r+1]=this[1]*o+this[5]*i+this[9]*a+this[13],n[r+2]=this[2]*o+this[6]*i+this[10]*a+this[14]}mulVec3AffineVec_(e,t){let n=this[0]*e.x+this[4]*e.y+this[8]*e.z,r=this[1]*e.x+this[5]*e.y+this[9]*e.z,o=this[2]*e.x+this[6]*e.y+this[10]*e.z;t.x=n,t.y=r,t.z=o}static fromRowMajor(e){e.length>0&&Array.isArray(e[0])&&(e=e.flatMap(e=>e));let t=e;16!==t.length&&console.log("need 16 elements");let n=new eT;for(let e=0;e<4;e++)for(let r=0;r<4;r++)n[4*e+r]=t[4*r+e];return n}static fromColMajor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e.length-t<16&&console.log("need 16 elements");let n=new eT;for(let r=0;r<16;r++)n[r]=e[t+r];return n}static fromTranslation(e){let t=new eT;return t[12]=e.x,t[13]=e.y,t[14]=e.z,t}static fromScaleTranslation(e,t){let n=new eT;return n[0]=e.x,n[5]=e.y,n[10]=e.z,n[12]=t.x,n[13]=t.y,n[14]=t.z,n}static fromAxisAngle(e,t){let n,r,o,i,a,l,s,c,u=new eT;return n=e.normalize(),r=Math.cos(t),o=Math.sin(t),i=n.x,a=n.y,l=n.z,s=1-r,c=0,u[0]=i*i*s+r,u[c+1]=a*i*s+l*o,u[c+2]=l*i*s-a*o,u[(c=4)+0]=i*a*s-l*o,u[c+1]=a*a*s+r,u[c+2]=l*a*s+i*o,u[(c=8)+0]=i*l*s+a*o,u[c+1]=a*l*s-i*o,u[c+2]=l*l*s+r,u}static fromQuat(e){let t,n,r,o,i,a,l,s=new eT;return n=0===(t=e.lenSq())?0:2/t,r=e.x,o=e.y,i=e.z,a=e.w,l=0,s[0]=1-n*(o*o+i*i),s[l+1]=n*(r*o+a*i),s[l+2]=n*(r*i-a*o),s[(l=4)+0]=n*(r*o-a*i),s[l+1]=1-n*(r*r+i*i),s[l+2]=n*(o*i+a*r),s[(l=8)+0]=n*(r*i+a*o),s[l+1]=n*(o*i-a*r),s[l+2]=1-n*(r*r+o*o),s}static fromScale(e){let t=new eT;return t[0]=e.x,t[5]=e.y,t[10]=e.z,t}static fromLookAt(e,t,n){let r=e.sub(t).normalize(),o=n.normalize(),i=K.cross(o,r).normalize();o=K.cross(r,i);let a=new eT;return a[0]=i.x,a[1]=o.x,a[2]=r.x,a[4]=i.y,a[5]=o.y,a[6]=r.y,a[8]=i.z,a[9]=o.z,a[10]=r.z,a[12]=-e.dot(i),a[13]=-e.dot(o),a[14]=-e.dot(r),a}static fromPersp(e,t,n,r){let o=n*Math.tan(e/2*Math.PI/180)*2,i=new eT;return i[0]=2*n/(o*t),i[5]=2*n/o,i[10]=-r/(r-n),i[11]=-1,i[14]=-r*n/(r-n),i[15]=0,i}static fromOrtho(e,t,n,r,o,i){let a=new eT;return a[0]=2/(t-e),a[5]=2/(r-n),a[10]=-2/(i-o),a[12]=-(t+e)/(t-e),a[13]=-(r+n)/(r-n),a[14]=-(i+o)/(i-o),a}static zeros(){let e=new eT;return e[0]=0,e[5]=0,e[10]=0,e[15]=0,e}decomposeToTRS(){let e,t=K.fromArray(this,12),n=new K(K.fromArray(this,0).len(),K.fromArray(this,4).len(),K.fromArray(this,8).len()),r=this[0]+this[5]+this[10];if(r>0){let t=Math.sqrt(1+r),n=.5/t;e=new Z((this[6]-this[9])*n,(this[8]-this[2])*n,(this[1]-this[4])*n,.5*t)}else if(this[0]>this[5]&&this[0]>this[10]){let t=Math.sqrt(1+this[0]-this[5]-this[10]),n=.5/t;e=new Z(.5*t,(this[1]+this[4])*n,(this[8]+this[2])*n,(this[6]-this[9])*n)}else if(this[5]>this[10]){let t=Math.sqrt(1+this[5]-this[0]-this[10]),n=.5/t;e=new Z((this[4]+this[1])*n,.5*t,(this[9]+this[6])*n,(this[8]-this[2])*n)}else{let t=Math.sqrt(1+this[10]-this[0]-this[5]),n=.5/t;e=new Z((this[8]+this[2])*n,(this[9]+this[6])*n,.5*t,(this[1]-this[4])*n)}return[t,e,n]}invertTRS(){let e=new eT,t=K.fromArray(this,0),n=K.fromArray(this,4),r=K.fromArray(this,8),o=K.fromArray(this,12);return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[12]=-t.dot(o),e[13]=-n.dot(o),e[14]=-r.dot(o),e}determinant(){let e=new Float64Array(this),t=new Int32Array(5);return ez(e,t,4),function(e,t,n){let r=e[0];for(let t=1;t<n;t++)r*=e[t*n+t];return t[n]-n&1?-r:r}(e,t,4)}invert(){let e=new Float64Array(this),t=new Int32Array(5);ez(e,t,4);let n=new eT;return function(e,t,n,r){for(let o=0;o<n;o++){for(let i=0;i<n;i++){r[i*n+o]=t[i]===o?1:0;for(let t=0;t<i;t++)r[i*n+o]-=e[i*n+t]*r[t*n+o]}for(let t=n-1;t>=0;t--){for(let i=t+1;i<n;i++)r[t*n+o]-=e[t*n+i]*r[i*n+o];r[t*n+o]/=e[t*n+t]}}}(e,t,4,n),n}toString(){let e="\n";for(let t=0;t<4;t++){e+=0===t?"[[":" [";for(let n=0;n<4;n++){let r=this.g(t,n);e+=(r<0?"":" ")+r.toFixed(3)+(3===n?"]":", ")}e+=3===t?"]":"\n"}return e}constructor(){super(16),this[0]=this[5]=this[10]=this[15]=1}}function ez(e,t,n){for(let e=0;e<=n;e++)t[e]=e;for(let r=0;r<n;r++){let o=0,i=r;for(let t=r;t<n;t++){let a=Math.abs(e[t*n+r]);a>o&&(o=a,i=t)}if(o<1e-9)return!1;if(i!==r){let o=t[r];t[r]=t[i],t[i]=o;for(let t=0;t<n;t++){let o=e[r*n+t];e[r*n+t]=e[i*n+t],e[i*n+t]=o}t[n]+=1}for(let t=r+1;t<n;t++){e[t*n+r]/=e[r*n+r];for(let o=r+1;o<n;o++)e[t*n+o]-=e[t*n+r]*e[r*n+o]}}}eT.identity=new eT;let eR={ModelView:0,Block:1,BlockAccess:2,blur:3};function eB(e,t,n){let{gl:r,modelViewUbo:o,modelViewBuf:i}=e;i.set(t,0),i.set(n,16),r.bindBuffer(r.UNIFORM_BUFFER,o),r.bufferSubData(r.UNIFORM_BUFFER,0,i)}(l=R||(R={}))[l.Opaque=0]="Opaque",l[l.Arrows=1]="Arrows",l[l.Overlay=2]="Overlay",l[l.Overlay2D=3]="Overlay2D";let eM="\n    layout(std140) uniform ModelViewUbo {\n        uniform mat4 u_model;\n        uniform mat4 u_view;\n    };";async function eD(){let e=document.createElement("img"),t=new Promise((t,n)=>{e.onload=()=>t(e),e.onerror=()=>n()});e.src="fonts/font-atlas.png";let n=fetch("fonts/font-def.json",{credentials:"include",mode:"no-cors"}).then(e=>e.json()),[r,o]=await Promise.all([t,n]);return{fontAtlasImage:r,fontDef:o}}function eF(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3?arguments[3]:void 0,o=r?e.atlas.faceInfos.find(e=>e.name===r):e.atlas.faceInfos[0],i=0,a="";for(let e of t){let t=o.charMap.get(e);if(!t)continue;let n="".concat(a).concat(e);i+=(o.kernMap.get(n)||0)+t.xadvance,a=e}return i*n/o.common.lineHeight*1.04}function eI(e,t,n){return eF(e,t,n.size,n.faceName)}function eP(e,t,n,r,o){ek(e,t,o.color,n,r,o.size,o.mtx,o.faceName)}function ek(e,t,n,r,o,i,a,l){let s=l?e.atlas.faceInfos.find(e=>e.name===l):e.atlas.faceInfos[0];s||(s=e.atlas.faceInfos[0]);let c=e.sharedRender.activePhase,u=e.vertBuffer.localBufs[c];ed(u,5*t.length),e.segmentsUsed===Math.floor(204.8)&&(e.segmentsUsed+=1);let d=e.segmentsUsed,f=u.buf,h=u.usedEls*e.vertBuffer.strideFloats,m=1/s.common.scaleW,p=1/s.common.scaleH,x=0,g=null!=r?r:0,v=null!=o?o:0,y="",_=(i=null!=i?i:1)/s.common.lineHeight*1.04;for(let e of t){let t=s.charMap.get(e);if(!t)continue;let n="".concat(y).concat(e);g+=(s.kernMap.get(n)||0)*_;let r=[t.x*m,(t.x+t.width)*m],o=[t.y*p,(t.y+t.height)*p],i=[g+t.xoffset*_,g+(t.xoffset+t.width)*_],a=[v+t.yoffset*_,v+(t.yoffset+t.height)*_],l=[0,1,0,0,1,1,1,1,0,0,1,0];for(let e=0;e<6;e++){let t=l[2*e],n=l[2*e+1];f[h++]=i[t],f[h++]=a[n],f[h++]=r[t],f[h++]=o[n],f[h++]=d}g+=t.xadvance*_,y=e,x+=1}if(u.usedEls+=6*x,a=null!=a?a:new eT,n=null!=n?n:new Z(1,1,1,1),e.segmentsUsed>=e.segmentCapacity){let t=2*e.segmentCapacity,n=new Float32Array(20*t);n.set(e.localTexBuffer),e.localTexBuffer=n}e.localTexBuffer.set(a,20*e.segmentsUsed+0),e.localTexBuffer.set(n.toArray(),20*e.segmentsUsed+16),e.segmentsUsed+=1}class eS{randint(e,t){return er(Math.floor(this.random()*(t-e)+e),e,t-1)}constructor(e){var t,n,r,o,i;let a;this.normal=()=>Math.sqrt(-2*Math.log(this.random()))*Math.cos(2*Math.PI*this.random()),this.random=(n=(a=function(e){for(var t=0,n=1779033703^e.length;t<e.length;t++)n=(n=Math.imul(n^e.charCodeAt(t),3432918353))<<13|n>>>19;return function(){return n=Math.imul((n=Math.imul(n^n>>>16,2246822507))^n>>>13,3266489909),(n^=n>>>16)>>>0}}(null!=(t=null==e?void 0:e.toString())?t:Math.random().toString()))(),r=a(),o=a(),i=a(),function(){n>>>=0,r>>>=0,o>>>=0,i>>>=0;var e=n+r|0;return n=r^r>>>9,r=o+(o<<3)|0,o=(o=o<<21|o>>>11)+(e=e+(i=i+1|0)|0)|0,(e>>>0)/4294967296})}}class eC{view(e){let t=e.reduce((e,t)=>e*t,1),n=this.shape.reduce((e,t)=>e*t,1);if(t!==n)throw Error("Invalid reshape: new size ".concat(t," (").concat(e.join(", "),") does not match existing size ").concat(n," (").concat(this.shape.join(", "),")"));if(!this.isContiguous)throw Error("Cannot view non-contiguous tensor (or at least, there are potential cases where it would work, but we don't support them yet)");return new eC(e,this.buffer)}transpose(e,t){if(e<0||e>=this.shape.length||t<0||t>=this.shape.length||e===t)throw Error("Invalid transpose indices: ".concat(e,", ").concat(t," over shape ").concat(this.shape.join(", ")));let n=[...this.shape],r=[...this.stride],o=n[e];n[e]=n[t],n[t]=o;let i=r[e];return r[e]=r[t],r[t]=i,new eC(n,this.buffer,r)}permute(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=new Set(Array(this.shape.length).fill(0).map((e,t)=>t));if(t.forEach(e=>r.delete(e)),t.length!==this.shape.length||0!==r.size)throw Error("Invalid permute axes: ".concat(t.join(", ")," over shape ").concat(this.shape.join(", ")));let o=t.map(e=>this.shape[e]),i=t.map(e=>this.stride[e]);return new eC(o,this.buffer,i)}g(e){return this.buffer[this.indexToOffset(e)]}s(e,t){this.buffer[this.indexToOffset(e)]=t}indexToOffset(e){if(e.length!==this.shape.length)throw Error("Index length ".concat(e.length," does not match shape length ").concat(this.shape.length));let t=0;for(let n=0;n<e.length;n++){if(e[n]>=this.shape[n])throw Error("Index ".concat(e[n]," out of bounds for shape ").concat(this.shape[n]));t+=e[n]*this.stride[n]}return t}*indexIterator(){let e=Array(this.shape.length).fill(0);for(;;){yield e;let t=this.shape.length-1;for(;t>=0&&(e[t]++,!(e[t]<this.shape[t]));)e[t]=0,t--;if(t<0)break}}contiguous(){return this.isContiguous?this:new eC(this.shape,this.toFloat32Array())}toFloat32Array(){let e=this.shape.reduce((e,t)=>e*t,1),t=new Float32Array(e);if(this.isContiguous)t.set(this.buffer);else{let e=Array(this.shape.length).fill(0),n=0,r=0;for(;;){t[n++]=this.buffer[r];let o=this.shape.length-1;for(;o>=0&&(e[o]++,r+=this.stride[o],!(e[o]<this.shape[o]));)r-=e[o]*this.stride[o],e[o]=0,o--;if(o<0)break}}return t}static fromJson(e){if(!e.shape||!e.dtype||!e.data)throw console.error("Invalid tensor json",e),Error("Invalid tensor json");if("torch.float32"!==e.dtype)throw console.error("Invalid tensor dtype",e),Error("Invalid tensor dtype");let t=eo(e.data),n=new Float32Array(t);return new eC(e.shape,n)}copyFrom(e){if(e.shape.length!==this.shape.length||!e.contiguous||!this.contiguous)throw Error("Invalid copy: source shape length ".concat(e.shape.length," does not match target shape length ").concat(this.shape.length));for(let t=0;t<this.shape.length;t++)if(e.shape[t]!==this.shape[t])throw Error("Invalid copy: source shape ".concat(e.shape[t]," does not match target shape ").concat(this.shape[t]));this.buffer.set(e.buffer)}constructor(e,t,n=[]){this.shape=e,this.buffer=t,this.stride=n;let r=e.reduce((e,t)=>e*t,1);if(r>t.length)throw Error("Shape ".concat(e.join(", ")," requires ").concat(r," buffer, but buffer has size ").concat(t.length));let o=Array(e.length),i=1;for(let t=e.length-1;t>=0;t--)o[t]=i,i*=e[t];if(0===n.length)this.stride=o;else if(n.length!==e.length)throw Error("Stride length ".concat(n.length," does not match shape length ").concat(e.length));this.isContiguous=!0;for(let e=0;e<n.length;e++)if(n[e]!==o[e]){this.isContiguous=!1;break}}}function eL(e){let t=(0,Y.useRef)(e);return(0,Y.useEffect)(()=>{t.current=e},[e]),t}class eU{constructor(){this.subs=new Set,this.subscribe=e=>(this.subs.add(e),()=>this.subs.delete(e)),this.notify=()=>{for(let e of this.subs)e()}}}function eO(e,t,n){let[r,o]=(0,Y.useState)(null),i=(0,Y.useRef)(!1),a=eL(e),l=eL(t),s=eL(n);return(0,Y.useEffect)(()=>{if(!r){i.current=!1;return}function e(e){let t,n;i.current||!((t=r.clientX-e.clientX)*t+(n=r.clientY-e.clientY)*n>10)&&l.current||(i.current=!0),i.current&&a.current(e,r,!1)}function t(e){var t,n;i.current||!l.current?(a.current(e,r,!0),null===(t=s.current)||void 0===t||t.call(s,e,r,!0)):null===(n=l.current)||void 0===n||n.call(l,e,r),o(null)}return document.addEventListener("mousemove",e,{capture:!0}),document.addEventListener("mouseup",t,{capture:!0}),()=>{document.removeEventListener("mousemove",e,{capture:!0}),document.removeEventListener("mouseup",t,{capture:!0})}},[r,a,l,s]),[r,(0,Y.useCallback)((e,t)=>{o({clientX:e.clientX,clientY:e.clientY,data:t,button:e.button,buttons:e.buttons,shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey})},[o])]}function eN(e,t,n,r,o,i){var a,l;let s=null!==(a=n.alwaysSendDragEvent)&&void 0!==a&&a,c=null!==(l=n.sendDragEnd)&&void 0!==l&&l,u=(0,Y.useRef)(t),d=(0,Y.useRef)(),f=(0,Y.useRef)(null),h=(0,Y.useRef)(!1),m=(0,Y.useRef)(t),p=(0,Y.useRef)(0);m.current=t;let x=eL(r),g=eL(o),v=eL(i);(0,Y.useEffect)(()=>{if(e)return e.addEventListener("touchstart",n,{passive:!1}),e.addEventListener("touchend",n,{passive:!1}),e.addEventListener("touchcancel",n,{passive:!1}),e.addEventListener("touchmove",t,{passive:!1}),()=>{e.removeEventListener("touchstart",n),e.removeEventListener("touchend",n),e.removeEventListener("touchcancel",n),e.removeEventListener("touchmove",t)};function t(e){let t={data:u.current,touches:d.current};if(e.touches&&t.touches&&e.touches.length===t.touches.length){var n,r;let o,i;!h.current&&(e.touches.length>1||1===e.touches.length&&(n=e.touches[0],Math.sqrt((o=(r=t.touches[0]).clientX-n.clientX)*o+(i=r.clientY-n.clientY)*i)>=10))&&(h.current=!0),1===e.touches.length&&x.current&&(s||h.current)&&x.current(e,{...t,isDragging:h.current},!1),2===e.touches.length&&g.current&&g.current(e,t),1===e.touches.length?f.current={time:0,velocity:0,touch:eX(e.touches)[0]}:f.current=null}}function n(e){var n;let r=d.current,o=u.current;u.current=m.current,d.current=eX(e.touches),r&&r.length||(p.current=performance.now());let i=null===(n=f.current)||void 0===n?void 0:n.touch;t(e),0===e.touches.length&&(c&&x.current&&i&&(h.current||s)&&(e=ej(e,{touches:[i]}),x.current(e,{data:o,touches:r,isDragging:h.current},!0)),!h.current&&v.current&&(null==r?void 0:r.length)===1&&v.current(e,{data:o,touches:r}),h.current=!1,f.current=null)}},[e,x,g,v,s,c])}function eX(e){let t=[];for(let n=0;n<e.length;n++){let r=e[n];t.push({clientX:r.clientX,clientY:r.clientY})}return t}function ej(e,t){return{...e,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation(),...t,button:-1,buttons:0}}function eV(e){return{clientX:e.clientX,clientY:e.clientY,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,button:-1,buttons:0}}function eY(e){switch(e){case B.t:case B.T:return Z.fromHexColor("#359da8");case B.A:return Z.fromHexColor("#d368a4");case B.C:case B.C4:return Z.fromHexColor("#ce2983");case B.Token:return new Z(.3,.7,.3,1);case B.TokenIdx:return Z.fromHexColor("#1b495d");case B.n_vocab:return Z.fromHexColor("#7c3c8d");case B.Intermediates:return Z.fromHexColor("#00ad00");case B.Weights:return eG.Weights;case B.Aggregates:return Z.fromHexColor("#e3a300")}return new Z(0,0,0)}(s=B||(B={}))[s.None=0]="None",s[s.t=1]="t",s[s.T=2]="T",s[s.C=3]="C",s[s.B=4]="B",s[s.A=5]="A",s[s.n_vocab=6]="n_vocab",s[s.n_heads=7]="n_heads",s[s.n_layers=8]="n_layers",s[s.Token=9]="Token",s[s.TokenIdx=10]="TokenIdx",s[s.C4=11]="C4",s[s.Intermediates=12]="Intermediates",s[s.Weights=13]="Weights",s[s.Aggregates=14]="Aggregates";let eG={Weights:new Z(.3,.3,1),Intermediates:new Z(.4,.8,.4),Aggregates:new Z(1,.8,.3),Black:new Z(0,0,0)};function eq(e,t,n,r){let{x:o,rangeOffsets:i}=tt(t,n),a=o+e.cell*r;if(!i)return a;for(let[e,t]of i)if(r<e)return a+t;return a}function eW(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{thick:+(t.thick||1),color:t.color||new Z(1,1,1,1),mtx:t.mtx||eT.identity,n:t.n||void 0,closed:t.closed||!1,dash:null!==(e=t.dash)&&void 0!==e?e:0}}function eH(e,t,n,r){eJ(e,r.thick,r.color,t,n,r.n,r.mtx,r.dash)}(c=M||(M={}))[c.None=0]="None",c[c.Attention=1]="Attention",(u=D||(D={}))[u.None=0]="None",u[u.Softmax=1]="Softmax",u[u.Gelu=2]="Gelu",u[u.LayerNorm=3]="LayerNorm",u[u.InputEmbed=4]="InputEmbed",u[u.LayerNormMu=5]="LayerNormMu",u[u.LayerNormSigma=6]="LayerNormSigma",u[u.SoftmaxAggMax=7]="SoftmaxAggMax",u[u.SoftmaxAggExp=8]="SoftmaxAggExp",u[u.Attention=9]="Attention";let eQ=new K,eK=new K,eZ=new K;function eJ(e,t,n,r,o,i,a,l,s){let c=e.sharedRender.activePhase,u=e.floatBuf.localBufs[0],d=u.buf,f=e.indexBuf.localBufs[c],h=f.buf;ed(u,4),ep(f,5),a?(a.mulVec3Affine_(r,eQ),a.mulVec3Affine_(o,eK)):(eQ.copy_(r),eK.copy_(o)),l=null!=l?l:0,eZ.x=eK.x-eQ.x,eZ.y=eK.y-eQ.y,eZ.z=eK.z-eQ.z;let m=eZ.len(),p=1/m;eZ.x*=p,eZ.y*=p,eZ.z*=p;let x=[eQ,eQ,eK,eK];i=null!=i?i:K.zero;let g=u.usedEls*u.strideFloats,v=f.usedVerts;for(let e=0;e<4;e++)d[g+0]=x[e].x,d[g+1]=x[e].y,d[g+2]=x[e].z,d[g+3]=eZ.x,d[g+4]=eZ.y,d[g+5]=eZ.z,d[g+6]=eZ.x,d[g+7]=eZ.y,d[g+8]=eZ.z,d[g+9]=n.x,d[g+10]=n.y,d[g+11]=n.z,d[g+12]=n.w,d[g+13]=t,d[g+14]=1,d[g+15]=i.x,d[g+16]=i.y,d[g+17]=i.z,d[g+18]=l,d[g+19]=e<2?0:m,g+=u.strideFloats,h[v+e]=u.usedEls+e;h[v+4]=4294967295,u.usedEls+=4,f.usedVerts+=5}let e$=new Float32Array(6),e0=e$.subarray(0,3),e1=e$.subarray(3,6),e2=new Float32Array(0);function e3(e,t,n){var r,o;let i=e.sharedRender.activePhase,a=e.floatBuf.localBufs[0],l=a.buf,s=e.indexBuf.localBufs[i],c=s.buf,u=t.length,d=(null!==(r=n.n)&&void 0!==r?r:K.zero).clone();if(n.mtx){e2.length<t.length&&(e2=new Float32Array(t.length));for(let e=0;e<t.length;e+=3)n.mtx.mulVec3AffineArr_(t,e,e2,e);t=e2,n.mtx.mulVec3AffineVec_(d,d)}let f=u/3+(n.closed?1:0);ed(a,4*f),ep(s,4*f+1),n.closed&&(ee.sub_(t,0,t,u-3,e1,0),ee.normalize_(e1,0,e1,0));let h=null!==(o=n.dash)&&void 0!==o?o:0,m=n.color.x,p=n.color.y,x=n.color.z,g=n.color.w,v=n.thick,y=d.x,_=d.y,b=d.z,w=0;for(let e=0;e<f;e++){let r=3*e;n.closed&&e===f-1&&(r=0);let o=0;!n.closed&&e<f-1||n.closed&&e!==f-2?(ee.sub_(t,r+3,t,r,e0,0),o=ee.len_(e0,0),ee.normalize_(e0,0,e0,0)):n.closed&&e===f-2&&(ee.sub_(t,0,t,u-3,e0,0),o=ee.len_(e0,0),ee.normalize_(e0,0,e0,0));let i=a.usedEls*a.strideFloats,d=s.usedVerts,A=0!=e||n.closed?e1:e0,E=e!=f-1||n.closed?e0:e1,T=n.closed&&e===f-1?2:4;for(let e=0;e<T;e++)ee.copy_(t,r,l,i),ee.copy_(A,0,l,i+3),ee.copy_(E,0,l,i+6),l[i+9]=m,l[i+10]=p,l[i+11]=x,l[i+12]=g,l[i+13]=v,l[i+14]=e>2?0:1,l[i+15]=y,l[i+16]=_,l[i+17]=b,l[i+18]=h,l[i+19]=w,i+=a.strideFloats,c[d+e]=a.usedEls+e;a.usedEls+=T,s.usedVerts+=T,w+=o,ee.copy_(e0,0,e1,0)}c[s.usedVerts]=4294967295,s.usedVerts+=1}function e4(e){for(;e.angle.x<0;)e.angle.x+=360;for(;e.angle.x>360;)e.angle.x-=360;let t=e.angle.z,n=e.angle.x*Math.PI/180,r=e.angle.y*Math.PI/180,o=200*t,i=e.center,a=new K(o*Math.cos(r)*Math.cos(n),o*Math.cos(r)*Math.sin(n),o*Math.sin(r)).add(i);return{lookAt:eT.fromLookAt(a,i,new K(0,0,1)),camPos:a}}function e5(e,t){return e.camera.camPosModel.dist(t)/e.render.size.y*5}function e6(e,t,n,r,o,i){let a=e.render,{vecId:l}=te(r),{cx:s}=tt(n,r),c=0===l?1:0,u=n.customDimText&&n.customDimText[r]||function(e){switch(e){case B.TokenIdx:return"Token Index";case B.C4:return"C * 4";default:return B[e]}}(o);if(o===B.None)return;let d=eq(t,n,r,0),f=eq(t,n,r,s-1)+t.cell,h=(f+d)/2,m=r===z.X?new K(h,n.y+n.dz,n.z+n.dz):new K(n.x,h,n.z+n.dz),p=r===z.X?-1:1,x=e5(e,m),g=2.5*(x=Math.min(x,1)),v=eF(a.modelFontBuf,u,g),y=r===z.X?v/2+.4*g:r===z.Y?g/2+.4*g:0,_=.3*g,b=g/2*.5,w=eY(o).mul(i),A=new K(n.x,n.y+n.dy,n.z+n.dz+.1).setAt(l,h).withAddAt(c,-p*(g/2+_)),E=0,T=v>f-d-2*y;T&&(E=p*g);let R=eT.fromTranslation(A),M=r===z.X?-v/2:r===z.Y?-v/2:0,D=r===z.X?-E-g/2:r===z.Y?-g/2:0;ek(a.modelFontBuf,u,w,M,D,g,R);let F=n.x,I=n.y+n.dy,P=n.z+n.dz+.1,k=.02*g,S=new K(0,0,1);T&&(y=0);let C=new K(F,I,P).withAddAt(c,-p*(g/2+_)),L=C.withSetAt(l,d),U=C.withSetAt(l,f),O=C.withSetAt(l,h-y),N=C.withSetAt(l,h+y);eJ(a.lineRender,k,w,L,O,S),eJ(a.lineRender,k,w,U,N,S),eJ(a.lineRender,k,w,L.withAddAt(c,b),L.withAddAt(c,-b),S),eJ(a.lineRender,k,w,U.withAddAt(c,b),U.withAddAt(c,-b),S)}let e8={vecId:0,xName:"x",dxName:"dx",cxName:"cx",offXName:"offX",sizeXName:"sizeX"},e9={vecId:1,xName:"y",dxName:"dy",cxName:"cy",offXName:"offY",sizeXName:"sizeY"},e7={vecId:2,xName:"z",dxName:"dz",cxName:"cz",offXName:"offZ",sizeXName:"sizeZ"};function te(e){return e===z.X?e8:e===z.Y?e9:e7}function tt(e,t){var n,r,o,i,a,l;switch(t){case z.X:return{x:e.x,cx:e.cx,dx:e.dx,rangeOffsets:e.rangeOffsetsX,offX:null!==(n=e.offX)&&void 0!==n?n:0,sizeX:null!==(r=e.sizeX)&&void 0!==r?r:e.cx};case z.Y:return{x:e.y,cx:e.cy,dx:e.dy,rangeOffsets:e.rangeOffsetsY,offX:null!==(o=e.offY)&&void 0!==o?o:0,sizeX:null!==(i=e.sizeY)&&void 0!==i?i:e.cy};case z.Z:return{x:e.z,cx:e.cz,dx:e.dz,rangeOffsets:e.rangeOffsetsZ,offX:null!==(a=e.offZ)&&void 0!==a?a:0,sizeX:null!==(l=e.sizeZ)&&void 0!==l?l:e.cz}}}function tn(e,t,n,r){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,{x:i,cx:a,rangeOffsets:l}=tt(t,n);if(a<=1)return t;if(l&&t.subs)for(let i of t.subs){let t=tr(e,i,n,r,o);if(t)return t}return tr(e,t,n,r,o)}function tr(e,t,n,r,o){let i,{offX:a,sizeX:l}=tt(t,n),s=[],c=[],u=Math.floor(r)-a;if(u<0||u>=l)return null;if(l<=1)return t;function d(r,o,i){var a;let l=to(e,t,n,r,o,i);return l&&(s.push(l.subBlock),c.push(l.rangeOffset)),null!==(a=null==l?void 0:l.subBlock)&&void 0!==a?a:null}if(0===o)d(0,u,0),i=d(u,u+1,0),d(u+1,l,0);else{let e=(r-u-.5)*.5+.5,t=e+.5<1,n=e-.5>0,a=ea(-o,0,(r-.5)*.5+.5);d(0,u-(t?1:0),a+0),t&&d(u-1,u,a+ea(o,0,e+.5)),i=d(u,u+1,a+ea(o,0,e)),n&&d(u+1,u+2,a+ea(o,0,e-.5)),d(u+(n?2:1),l,a+o)}return s.length>0?(n===z.X&&(t.rangeOffsetsX=c),n===z.Y&&(t.rangeOffsetsY=c),n===z.Z&&(t.rangeOffsetsZ=c),t.subs=s,i):null}function to(e,t,n,r,o,i){var a;let{x:l,cx:s,sizeX:c,offX:u}=tt(t,n),{vecId:d,xName:f,dxName:h,offXName:m,sizeXName:p}=te(n);if(r>=o||o<=0||r>=c)return null;let x=eT.fromScaleTranslation(new K(1,1,1).setAt(d,(o-r)/c),new K().setAt(d,r/c));return{subBlock:{...t,[h]:(o-r)*e.cell,access:t.access&&{...t.access},localMtx:(null!==(a=t.localMtx)&&void 0!==a?a:new eT).mul(x),[f]:l+(r*e.cell+i),[m]:r+u,[p]:o-r},rangeOffset:[o,i]}}(d=F||(F={}))[d.Top=0]="Top",d[d.Middle=1]="Middle",d[d.Bottom=2]="Bottom",(f=I||(I={}))[f.Left=0]="Left",f[f.Center=1]="Center",f[f.Right=2]="Right";let ti={state:null},ta=new K(0,0,1),tl=new K,ts=new K;function tc(e,t,n,r,o){let i=e.sharedRender.activePhase,a=e.vbo.localBufs[0],l=e.ibo.localBufs[i];ed(a,1),ep(l,1);let s=a.buf,c=l.buf,u=a.usedEls*a.strideFloats,d=l.usedVerts;o?(o.mulVec3Affine_(t,tl),o.mulVec3AffineVec_(r||ta,ts)):(tl.copy_(t),ts.copy_(r||ta)),s[u+0]=tl.x,s[u+1]=tl.y,s[u+2]=tl.z,s[u+3]=ts.x,s[u+4]=ts.y,s[u+5]=ts.z,s[u+6]=n.x,s[u+7]=n.y,s[u+8]=n.z,s[u+9]=n.w,s[u+10]=0,s[u+11]=0,c[d]=a.usedEls,a.usedEls+=1,l.usedVerts+=1}let tu=new K,td=new K;function tf(e,t,n,r,o){let i=!(arguments.length>5)||void 0===arguments[5]||arguments[5];if(tu.x=n.x,tu.y=t.y,tu.z=t.z,td.x=t.x,td.y=n.y,td.z=n.z,tc(e,t,r,void 0,o),tc(e,td,r,void 0,o),tc(e,tu,r,void 0,o),tc(e,n,r,void 0,o),i){let t=e.sharedRender.activePhase,n=e.ibo.localBufs[t];ep(n,1),n.buf[n.usedVerts++]=4294967295}}function th(e){var t,n,r,o,i;let a=null!==(n=e.type)&&void 0!==n?n:e.text?P.Text:e.subs?P.Line:en(e.cellX)&&en(e.cellY)?P.Cells:null;if(et(a))throw Error("Unknown text block type");let l=e.opts;if(l&&e.color&&(l={...l,color:e.color}),!l)throw Error("No font opts");return{type:a,id:e.id,text:e.text,align:e.align,opts:l,size:null!==(r=e.size)&&void 0!==r?r:new K(0,0,0),offset:null!==(o=e.offset)&&void 0!==o?o:new K(0,0,0),subs:null===(t=e.subs)||void 0===t?void 0:t.filter(en).map(e=>th({...e,opts:null!==(i=e.opts)&&void 0!==i?i:l})),rectOpts:e.rectOpts,draw:e.draw,cellX:e.cellX,cellY:e.cellY}}function tm(e,t){return{tl:new K(.9*t.size.y,.2*t.size.y),br:new K(.1*t.size.y,0)}}function tp(e){return{size:new K(7*e.cellX,7*e.cellY),pad:7}}function tx(e,t){let n=t.opts;switch(t.type){case P.Line:{let n=0,r=0;for(let o of t.subs)tx(e,o),n+=o.size.x,r=Math.max(r,o.size.y);t.size=new K(n,r,0),t.rectOpts&&(t.size.x+=3.5,t.size.y+=3.5);break}case P.Text:if(et(t.text))throw Error("Text block has no text");t.size=new K(Math.max(t.size.x,eI(e.modelFontBuf,t.text,n)),1.2*n.size);break;case P.Sqrt:{let r=t.subs[0];tx(e,r);let o=tm(n,r);t.size=r.size.add(o.tl).add(o.br);break}case P.Divide:{let n=t.subs[0],r=t.subs[1];tx(e,n),tx(e,r);let o={padX:0,padInnerY:.5*n.size.y};t.size=new K(Math.max(n.size.x,r.size.x)+o.padX,n.size.y+r.size.y+o.padInnerY,0);break}case P.Cells:{let e=tp(t);t.size=new K(e.size.x+e.pad,e.size.y);break}case P.Custom:break;default:t.type}}function tg(e){switch(e.type){case P.Line:{let t=e.offset.x+1.75,n=e.offset.y+e.size.y/2;for(let r of e.subs)r.offset=new K(t,n-r.size.y/2).round_(),tg(r),t+=r.size.x;break}case P.Sqrt:{let t=e.subs[0];t.offset=e.offset.add(tm(e.opts,t).tl).round_(),tg(t);break}case P.Divide:{let t=e.subs[0],n=e.subs[1],r=e.size.x/2;t.offset=e.offset.add(new K(r-t.size.x/2,0)).round_(),n.offset=e.offset.add(new K(r-n.size.x/2,e.size.y-n.size.y)).round_(),tg(t),tg(n);break}case P.Text:case P.Cells:case P.Custom:break;default:e.type}}function tv(e,t){switch(t.type){case P.Line:for(let n of t.subs)tv(e,n);if(t.rectOpts){let n=eW(t.rectOpts),r=t.offset.round().add(new K(.5,.5)),o=t.offset.add(t.size).round().add(new K(.5,.5));tM(e,r,o,n.color.mul(.24),n.mtx,2),tb(e,r,o,n)}break;case P.Text:{let n=t.offset.x;t.align===I.Right&&(n=t.offset.x+t.size.x-eI(e.modelFontBuf,t.text,t.opts)),eP(e.modelFontBuf,t.text,n,t.offset.y+.1*t.opts.size,t.opts);break}case P.Sqrt:{let n=t.subs[0],r=n.size.y,o=t.offset.x,i=t.offset.y-.9*r,a=1.8*r,l={...t.opts,faceName:"cmsy10",size:a},s=eW({color:t.opts.color,n:new K(0,0,1),mtx:t.opts.mtx,thick:.4}),c=o+.5*a,u=i+.5*a;eH(e.lineRender,new K(c,u).round_(),new K(n.offset.x+n.size.x,u).round_(),s),eP(e.modelFontBuf,"p",o,i,l),tv(e,n);break}case P.Divide:{let n=t.subs[0],r=t.subs[1],o=eW({color:t.opts.color,n:new K(0,0,1),mtx:t.opts.mtx,thick:.4}),i=ei(n.offset.y+n.size.y,r.offset.y,.5)+1;eH(e.lineRender,new K(t.offset.x,i),new K(t.offset.x+t.size.x,i),o),tv(e,t.subs[0]),tv(e,t.subs[1]);break}case P.Cells:{let n=t.offset.add(new K(t.size.x/2,t.size.y/2)),r=tp(t);ty(e,new K(t.cellX,t.cellY),n,r.size,t.opts.color,t.opts.mtx);break}case P.Custom:var n;null===(n=t.draw)||void 0===n||n.call(t,t,e);break;default:t.type}}function ty(e,t,n,r,o,i){let a=n.mulAdd(r,-.5).add(new K(.5,.5)),l=n.mulAdd(r,.5).add(new K(.5,.5)),s=eW({color:o,mtx:i,n:new K(0,0,1),thick:.4});tb(e,a,l,s),tf(e.triRender,a,l,o.mul(.3),i);for(let n=1;n<t.x;n++){let t=a.x+7*n;eH(e.lineRender,new K(t,a.y,0),new K(t,l.y,0),s)}for(let n=1;n<t.y;n++){let t=a.y+7*n;eH(e.lineRender,new K(a.x,t,0),new K(l.x,t,0),s)}}(h=P||(P={}))[h.Line=0]="Line",h[h.Text=1]="Text",h[h.Sqrt=2]="Sqrt",h[h.Divide=3]="Divide",h[h.Cells=4]="Cells",h[h.Custom=5]="Custom";let t_=new Float32Array(12);function tb(e,t,n,r){t_[0]=t.x,t_[1]=t.y,t_[2]=0,t_[3]=n.x,t_[4]=t.y,t_[5]=0,t_[6]=n.x,t_[7]=n.y,t_[8]=0,t_[9]=t.x,t_[10]=n.y,t_[11]=0,e3(e.lineRender,t_,eW({...r,closed:!0}))}function tw(e,t){let n=e.camera.modelMtx,r=e.camera.viewMtx.mulVec3Proj(n.mulVec3Affine(t));return new K((r.x+1)*.5*e.render.size.x,(1-r.y)*.5*e.render.size.y,0)}let tA=new Z(.4,.4,.9,1),tE=new Z(.3,.7,.3,1),tT=new Z(.9,.9,.9,1),tz=new Z(0,0,0,1).mul(1),tR=new Z(1,1,1,1);function tB(e,t){var n;let r=null===(n=e.access)||void 0===n?void 0:n.src.localBuffer;if(!e.access||!r)return null;let o=e.access.src,i=e.access.mat.mulVec4(new Z(t.x,t.y,t.z,1)),a="r"===e.access.channel?0:"g"===e.access.channel?1:"b"===e.access.channel?2:3;return r[i.y*o.width*o.channels+i.x*o.channels+a]}function tM(e,t,n,r,o,i){var a;let l,s;if(0===i){tf(e.triRender,t,n,r,o);return}i=Math.min(i,(n.x-t.x)/2,(n.y-t.y)/2);let c=new K(0,0,1),u=t.add(new K(i,i)),d=n.sub(new K(i,i));tf(e.triRender,u,d,r,o),tc(e.triRender,new K(d.x,n.y),r,c,o),tc(e.triRender,new K(d.x,d.y),r,c,o);for(let t=0;t<4;t++){let n=new K(t<2?u.x:d.x,(t+1)%4<2?d.y:u.y),a=(t+1)%4*Math.PI/2;for(let t=0;t<7;t++){let l=new K(n.x+i*Math.cos(a+t*Math.PI/6/2),n.y+i*Math.sin(a+t*Math.PI/6/2));tc(e.triRender,l,r,c,o),tc(e.triRender,n,r,c,o)}}l=(a=e.triRender).sharedRender.activePhase,ep(s=a.ibo.localBufs[l],1),s.buf[s.usedVerts++]=4294967295}function tD(e,t,n,r){let{state:o,mtx:i}=e,a=tB(e.blk,e.destIdx);n.type===P.Line&&(n.subs.push(th({text:"  =  ",opts:n.opts})),en(a)&&n.subs.push(th({text:a.toFixed(2),opts:n.opts,size:new K(35,0),align:I.Right}))),tx(o.render,n),n.offset=new K(t.x-n.size.x/2,t.y-n.size.y),tg(n);let l=n.offset.sub(new K(4+tF(r,2),4+tF(r,0))),s=n.offset.add(n.size).add(new K(8+tF(r,1),4+tF(r,3)));return tM(o.render,l,s,tz,i,4),tv(o.render,n),new $(l,s)}function tF(e,t){return Array.isArray(e)?e[t]:"number"==typeof e?e:0}function tI(e,t,n,r){let o=(t-e)/(r-n),i=e-o*n;return e=>o*e+i}function tP(e,t){if(e.subs)for(let n of e.subs)tP(n,t);else t(e)}function tk(e,t){let n=e.srcIdxMtx,r=0!==n.g(0,3),o=0!==n.g(1,3),i=n.mulVec4(Z.fromVec3(t,0)),a=new K(i.x,i.y,i.z),l=r?z.Y:z.X;return{srcIdx:a,dotDim:l,otherDim:l===z.X?z.Y:z.X,isDot:r||o}}function tS(e,t){var n;if(!(null===(n=e.deps)||void 0===n?void 0:n.dot))return null;let r=null,o=e.deps.dot.find(e=>{var t;return null===(t=e.src.deps)||void 0===t?void 0:t.lowerTri});if(o){let{srcIdx:e,dotDim:n}=tk(o,t);r=e.getAt(n)}return r}(m=k||(k={}))[m.Intro=0]="Intro",m[m.Detailed_Input=1]="Detailed_Input",(p=S||(S={}))[p.None=0]="None",p[p.Intro_Intro=1]="Intro_Intro",p[p.Input_First=2]="Input_First",p[p.Input_Detail_Tables=3]="Input_Detail_Tables",p[p.Input_Detail_TokEmbed=4]="Input_Detail_TokEmbed",p[p.LayerNorm1=5]="LayerNorm1",p[p.Intro_Prelim=6]="Intro_Prelim",p[p.Input_Detail_Embedding=7]="Input_Detail_Embedding",p[p.Input_Detail_LayerNorm=8]="Input_Detail_LayerNorm",p[p.Input_Detail_SelfAttention=9]="Input_Detail_SelfAttention",p[p.Input_Detail_Softmax=10]="Input_Detail_Softmax",p[p.Input_Detail_Projection=11]="Input_Detail_Projection",p[p.Input_Detail_Mlp=12]="Input_Detail_Mlp",p[p.Input_Detail_Transformer=13]="Input_Detail_Transformer",p[p.Input_Detail_Output=14]="Input_Detail_Output";var tC=n(91279);(x=C||(C={}))[x.Cell=0]="Cell",x[x.PosEmbed=1]="PosEmbed",x[x.Block=2]="Block",x[x.Gap=3]="Gap";let tL=(0,Y.createContext)(null);function tU(){let e=(0,Y.useContext)(tL);return!function(e){let[,t]=(0,Y.useReducer)(e=>e+1,0);(0,Y.useEffect)(()=>null==e?void 0:e.subscribe(t),[e])}(null==e?void 0:e.htmlSubs),e}function tO(e){let t;arguments.length>1&&void 0!==arguments[1]?arguments[1]:new K(0,0,0);let n=[],r=(null==e?void 0:e.einsumStates)?e.einsumStates[e.currentEinsumState].state:null,o=(null==r?void 0:r.operands)?[...r.operands]:[{name:"EMPTY",shape:[32,32]}],i=[];(null==r?void 0:r.output)&&(o.push({...r.output}),console.log(r.output),Array.isArray(r.output.inputDims)&&(t=r.output.freeDims,i=[...r.output.inputDims,t.join("")]));let a=new K;for(let e=0;e<o.length;e++){let t,r;let l=o[e].shape;i&&e<i.length&&(t=i[e],console.log(e,"thisOpDimNames",t)),o.length>1&&e==o.length-1&&(n[n.length-1],n[0],o[e].relmap);let s=o[e].name;s||(s=String.fromCharCode(65+e));let c=function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new K;if(!t)return e([1,1],n);let r=t.length;if(0==r)return e([1,1],n);if(1==r)return e([t[0],1],n);if(2==r){let[e,r]=t,o=[{coords:n,cy:e,cx:r}],i={frontUpLeft:n,frontDownLeft:n.add(new K(0,e)),frontUpRight:n.add(new K(r)),rearUpLeft:n.add(new K(0,0,-1))};return{cubes:o,blockDescription:i}}let o=t[0],i=t.slice(1),a=[],l=n.clone(),s=Math.ceil(r/3)-1,c=5*Math.pow(3,s),u=null;for(let t=0;t<o;t++){let n=e(i,l);a=a.concat(n.cubes);let o=n.blockDescription;0==t&&(u=o),r%3==0?(l=o.rearUpLeft.add(new K(0,0,-c)),u.rearUpLeft=o.rearUpLeft):r%3==2?(l=o.frontUpRight.add(new K(c)),u.frontUpRight=o.frontUpRight):(l=o.frontDownLeft.add(new K(0,c)),u.frontDownLeft=o.frontDownLeft)}return{cubes:a,blockDescription:u}}(l,a);c.cubes.map(e=>{let o=function(e){var t,n,r,o,i,a,l,s;let c;let u=[e.xL,e.xR,e.xM].map(e=>+!et(e)).reduce((e,t)=>e+t,0),d=[e.zF,e.zB,e.zM].map(e=>+!et(e)).reduce((e,t)=>e+t,0);if(1!==u||1!==d)throw Error("Must supply exactly 1 x arg & 1 y arg: ".concat(JSON.stringify(e)));let f=1.5*e.cx,h=1.5*e.cz,m=et(e.xL)?et(e.xR)?e.xM-f/2:e.xR-f:e.xL,p=et(e.zB)?et(e.zF)?e.zM-h/2:e.zF-h:e.zB;function x(e){return 4===e.length?e:[...e,0]}return{dx:1.5*e.cx,dy:1.5*e.cy,dz:1.5*e.cz,t:e.t,x:m,y:e.y,z:p,cx:e.cx,cy:e.cy,cz:e.cz,dimX:e.dimX,dimY:e.dimY,name:null!==(n=e.name)&&void 0!==n?n:"<unknown>",access:(null===(t=e.access)||void 0===t?void 0:t.src)?{channel:null!==(r=e.access.channel)&&void 0!==r?r:"r",src:e.access.src,scale:null!==(o=e.access.scale)&&void 0!==o?o:1,mat:eT.fromColMajor([...x(e.access.x),...x(e.access.y),0,0,0,0,0,0,0,0])}:void 0,deps:e.deps?(l=e.deps,c=(e,t)=>({src:e,srcIdxMtx:function(e){let t=eT.zeros();for(let n=0;n<e.length;n++){let r="0xybi".indexOf(e[n]);r>0&&t.s(n,r-1,1)}return t}(t)}),{dot:l.dot&&l.dot.map(e=>{let[t,n]=e;return c(t,n)}),dotLen:l.dotLen,add:l.add&&l.add.map(e=>{let[t,n]=e;return c(t,n)}),special:null!==(s=l.special)&&void 0!==s?s:U.None,lowerTri:l.lowerTri}):void 0,meinsumResult:e.meinsumResult,opacity:e.hidden?0:1,highlight:0,small:null!==(i=e.small)&&void 0!==i&&i,special:null!==(a=e.special)&&void 0!==a?a:L.None,transpose:e.transpose,idx:-1}}({t:"w",xL:e.coords.x,zF:e.coords.z,y:e.coords.y,cx:e.cx,cz:1,cy:e.cy,meinsumResult:r,deps:null,access:{x:[0,1,0],y:[1,0,0],scale:10},dimX:B.A,dimY:B.B,name:s}),i={};t&&(t.length>0&&(i[z.X]=t[t.length-1]),t.length>1&&(i[z.Y]=t[t.length-2]),1==t.length&&(i[z.Y]=t[t.length-1],i[z.X]="1")),o.customDimText=i,n.push(o)}),a=c.blockDescription.frontUpRight.add(new K(10))}for(let e=0;e<n.length;e++)n[e].idx=e;return{cubes:n,cell:1.5,margin:10,height:0,labels:[]}}function tN(e){if(!e)return null;let t=e.gl,n="\n    layout (std140) uniform BlockUbo {\n        uniform vec3 u_offset;\n        uniform vec3 u_size;\n        uniform vec3 u_nCells;\n        uniform mat4 u_localPosMtx;\n        uniform vec4 u_baseColor;\n        uniform float u_highlight;\n    };",r="\n    layout (std140) uniform BlockAccessUbo {\n        layout(row_major) uniform mat4x2 u_accessMtx;\n        uniform float u_accessTexChannel;\n        uniform float u_accessTexScale;\n    };",o=eu(t,t.UNIFORM_BUFFER,t.createBuffer(),1024,144,null),i=eu(t,t.UNIFORM_BUFFER,t.createBuffer(),1024,80,null),a=function(e){let t=[-1,1,-1,-1,1,1,1,1,-1,-1,1,-1],n=[new eT,eT.fromAxisAngle(new K(1,0),Math.PI/2),eT.fromAxisAngle(new K(1,0),Math.PI),eT.fromAxisAngle(new K(1,0),-Math.PI/2),eT.fromAxisAngle(new K(0,1),Math.PI/2),eT.fromAxisAngle(new K(0,1),-Math.PI/2)],r=eT.fromTranslation(new K(.5,.5,.5)).mul(eT.fromScale(new K(.5,.5,.5))),o=new Float32Array(216),i=0;for(let e of n)for(let n=0;n<6;n++){let a=r.mulVec3Proj(e.mulVec3Proj(new K(t[2*n],t[2*n+1],-1))),l=e.mulVec3Proj(new K(0,0,-1));o[i++]=Math.round(a.x),o[i++]=Math.round(a.y),o[i++]=Math.round(a.z),o[i++]=l.x,o[i++]=l.y,o[i++]=l.z}let a=e.createVertexArray();e.bindVertexArray(a);let l=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),ec(e,l,{},[{name:"a_position",size:3},{name:"a_normal",size:3}]),{name:"cube",vao:a,vbo:l,type:e.TRIANGLES,numVerts:36}}(t),l=t.createVertexArray();t.bindVertexArray(l),t.bindBuffer(t.ARRAY_BUFFER,a.vbo),ec(t,a.vbo,{},[{name:"a_position",size:3},{name:"a_normal",size:3}]);let s=t.createBuffer(),c=ec(t,s,{locOffset:2,divisor:1},[{name:"a_offset",size:4},{name:"a_size",size:4},{name:"a_nCells",size:4},{name:"a_localPosMtx0",size:4},{name:"a_localPosMtx1",size:4},{name:"a_localPosMtx2",size:4},{name:"a_localPosMtx3",size:4},{name:"a_baseColor",size:4},{name:"a_highlight",size:1}]),u=eu(t,t.ARRAY_BUFFER,s,1024,c,null),d=t.createTexture();function f(e){return"#version 300 es\n        precision highp float;\n\n        ".concat(eM,"\n\n        ").concat(e?"":n,"\n\n        ").concat(r,"\n\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n        out vec3 v_normal;\n        out vec3 v_modelPos;\n        out vec3 v_blockPos;\n        out vec2 v_accessPos;\n        out vec3 v_cubePos;\n\n        ").concat(e?"\n            layout(location = 2) in vec4 a_offset;\n            layout(location = 3) in vec4 a_size;\n            layout(location = 4) in vec4 a_nCells;\n            layout(location = 5) in vec4 a_localPosMtx0;\n            layout(location = 6) in vec4 a_localPosMtx1;\n            layout(location = 7) in vec4 a_localPosMtx2;\n            layout(location = 8) in vec4 a_localPosMtx3;\n            layout(location = 9) in vec4 a_baseColor;\n            layout(location = 10) in float a_highlight;\n\n            out vec4 u_baseColor;\n            out float u_highlight;\n        ":"","\n\n        void main() {\n            ").concat(e?"\n                vec3 u_offset = a_offset.xyz;\n                vec3 u_size = a_size.xyz;\n                vec3 u_nCells = a_nCells.xyz;\n                mat4 u_localPosMtx = mat4(a_localPosMtx0, a_localPosMtx1, a_localPosMtx2, a_localPosMtx3);\n                u_baseColor = a_baseColor;\n                u_highlight = a_highlight;\n            ":"","\n\n            vec3 localPos = (u_localPosMtx * vec4(a_position, 1.0)).xyz;\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n            v_normal = a_normal;\n            v_modelPos = model_pos;\n            v_blockPos = localPos * u_nCells;\n            v_accessPos = u_accessMtx * vec4(v_blockPos, 1.0);\n            v_cubePos = localPos;\n            ").concat(e?" ":"","\n        }")}function h(e){return"#version 300 es\n        precision highp float;\n        in vec3 v_normal;\n        out vec4 o_color;\n        in vec3 v_blockPos;\n        in vec3 v_cubePos;\n        in vec3 v_modelPos;\n        in vec2 v_accessPos;\n        uniform vec3 u_camPos; // in model space\n\n        ".concat(e?"\n            in vec4 u_baseColor;\n            in float u_highlight;\n        ":n,"\n\n        ").concat(r,"\n\n        uniform sampler2D u_accessSampler;\n\n        void main() {\n            ivec3 blockPos = ivec3(v_blockPos - v_normal * 0.1);\n\n            bool cellDark = (blockPos.x + blockPos.y + blockPos.z) % 2 == 0;\n\n            float maxDist = 4000.0;\n            float minDist = 600.0;\n            float dist = distance(u_camPos, v_modelPos);\n            float t = clamp((dist - minDist) / (maxDist - minDist), 0.0, 1.0);\n\n            vec3 baseColor = mix(u_baseColor.rgb, vec3(0.5, 0.5, 0.5), 0.5);\n            if (cellDark) {\n                baseColor *= mix(0.9, 1.0, t);\n            }\n\n            if (u_accessTexScale > 0.0 && dist < maxDist) { // have access texture\n                vec3 texBaseColor = mix(baseColor, vec3(0.5, 0.5, 0.5), 0.8);\n\n                vec3 d = fract(v_blockPos) - 0.5;\n                float r2 = 0.3*0.3;\n                bool insideX = d.y * d.y + d.z * d.z < r2;\n                bool insideY = d.x * d.x + d.z * d.z < r2;\n                bool insideZ = d.x * d.x + d.y * d.y < r2;\n                bool insideAny = insideX || insideY || insideZ;\n\n                if (insideAny) {\n                    ivec2 accessPos = ivec2(u_accessMtx * vec4(blockPos, 1.0));\n                    vec4 valVec = texelFetch(u_accessSampler, accessPos, 0) * u_accessTexScale;\n                    float val = u_accessTexChannel == 0.0 ? valVec.r : u_accessTexChannel == 1.0 ? valVec.g : valVec.b;\n\n                    float weight = clamp(abs(val), 0.0, 1.0);\n\n                    vec3 negColor = vec3(0.0, 0.0, 0.0);\n                    vec3 posColor = u_baseColor.rgb; // vec3(0.0, 1.0, 0.0);\n                    vec3 zeroColor = vec3(0.5, 0.5, 0.5);\n                    texBaseColor = mix(mix(zeroColor, negColor, weight), mix(zeroColor, posColor, weight), step(0.0, val));\n                }\n\n                baseColor = mix(texBaseColor, baseColor, t);\n            }\n\n            if (true) {\n                vec3 block16 = v_blockPos / 16.0;\n                vec3 pxPerBlock16 = 1.0 / fwidth(block16);\n                float strength16 = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                vec3 colorEdge = vec3(1.0, 1.0, 1.0);\n                vec3 color16 = vec3(1.0, 1.0, 1.0) * 0.7;\n                vec3 color256 = vec3(1.0, 1.0, 1.0);\n\n                // if we're zoomed out enough, show 256 & (256 * 16) grid lines\n                // the 16 grid lines are faded out by this point (fade out between 10px -> 1px)\n                if (strength16 < 2.0) {\n                    block16 = block16 / 16.0;\n                    pxPerBlock16 = 1.0 / fwidth(block16);\n                    strength16 = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                    color16 = color256;\n                    // orange\n                    color256 = vec3(1.0, 0.7, 0.4);\n                }\n\n                float visibility16 = smoothstep(2.0, 10.0, strength16); // below 10px between lines, fade out\n                vec3 block16Grid = 1.0 - abs(fract(block16 - 0.5) - 0.5) * pxPerBlock16;\n                float line16 = max(max(block16Grid.x, block16Grid.y), block16Grid.z) * visibility16;\n\n                vec3 block256 = block16 / 16.0;\n                vec3 block256Grid = 1.0 - abs(fract(block256 - 0.5) - 0.5) / fwidth(block256);\n                float line256 = max(max(block256Grid.x, block256Grid.y), block256Grid.z);\n\n                vec3 cube = v_cubePos - v_normal * 0.1;\n                vec3 cubeGrid = 1.0 - abs(fract(cube - 0.5) - 0.5) / fwidth(cube);\n                float lineCube = max(max(cubeGrid.x, cubeGrid.y), cubeGrid.z);\n\n                float bestPxPerBlock = min(min(pxPerBlock16.x, pxPerBlock16.y), pxPerBlock16.z);\n                float edgeWeight = smoothstep(0.0, 1.0, max(max(line16, lineCube), line256));\n                vec3 color = lineCube > 0.0 ? colorEdge : (line256 > 0.0 ? color256 : color16);\n                baseColor = mix(baseColor, color, edgeWeight);\n            }\n\n            vec3 color = mix(baseColor * 0.7, u_baseColor.rgb, u_highlight);\n\n            o_color = vec4(color, 1) * u_baseColor.a;\n        }")}t.bindTexture(t.TEXTURE_2D,d),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let m=el(e,"block",f(!1),h(!1),["u_camPos","u_accessSampler"],{uboBindings:{ModelViewUbo:eR.ModelView,BlockUbo:eR.Block,BlockAccessUbo:eR.BlockAccess}}),p=el(e,"block-instanced",f(!0),h(!0),["u_camPos","u_accessSampler"],{uboBindings:{ModelViewUbo:eR.ModelView,BlockAccessUbo:eR.BlockAccess}});return{gl:t,cubeGeom:a,shader:m,simpleShader:el(e,"block-simple","#version 300 es\n        precision highp float;\n        ".concat(eM,"\n        uniform vec3 u_size;\n        uniform vec3 u_offset;\n\n        layout(location = 0) in vec3 a_position;\n        void main() {\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n        }\n    "),"#version 300 es\n        precision highp float;\n        out vec4 o_color;\n        uniform vec4 u_baseColor;\n\n        void main() {\n            o_color = u_baseColor;\n        }\n    ",["u_size","u_offset","u_baseColor"],{uboBindings:{ModelViewUbo:eR.ModelView}}),blockUbo:o,blockAccessUbo:i,dummyTexture:d,instancedShader:p,instancedVao:l,instancedFloatBuf:u,instancedDataStale:!0,instancedNumBlocks:0}}async function tX(){let e=await fetch("/native.wasm"),t="",n=new WebAssembly.Memory({initial:1,maximum:256}),r={env:{memory:n},odin_env:{write:(e,n,o)=>{let i=new Uint8Array(r.env.memory.buffer,n,o),a=new TextDecoder().decode(i).split("\n");for(let e=0;e<a.length-1;e++)console.log(t+a[e]),t="";t+=a[a.length-1]},time_now:()=>BigInt(Date.now())*BigInt(1e6)},odin_dom:{init_event_raw:e=>{console.log("ODIN: init_event_raw",e)}}},o=await WebAssembly.instantiateStreaming(e,r),i=o.instance.exports;return i.init_allocator(i.__heap_base),new tj(o,i,n)}(g=L||(L={}))[g.None=0]="None",g[g.Attention=1]="Attention",(v=U||(U={}))[v.None=0]="None",v[v.Softmax=1]="Softmax",v[v.Gelu=2]="Gelu",v[v.LayerNorm=3]="LayerNorm",v[v.InputEmbed=4]="InputEmbed",v[v.LayerNormMu=5]="LayerNormMu",v[v.LayerNormSigma=6]="LayerNormSigma",v[v.SoftmaxAggMax=7]="SoftmaxAggMax",v[v.SoftmaxAggExp=8]="SoftmaxAggExp",v[v.Attention=9]="Attention";class tj{createModel(e){var t;return this.exports.wasm_create_model(null!==(t=e.B)&&void 0!==t?t:1,e.block_size,e.n_embd,e.n_layer,e.n_head,e.vocab_size)}runModel(e){this.exports.wasm_run_model(e)}getModelTensor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=this.exports.wasm_get_model_tensor(e,t,n);this.checkViews();let o=this.int32View[r/4],i=this.int32View[r/4+1],a=this.ptrView[r/4+2],l=this.ptrView[r/4+3],s=this.ptrView[r/4+4],c=new Int32Array(this.memory.buffer,l,i),u=new Int32Array(this.memory.buffer,s,i),d=new Float32Array(this.memory.buffer,a,o);return new eC([...c],d,[...u])}checkViews(){this.viewBuf!==this.memory.buffer&&(this.viewBuf=this.memory.buffer,this.int32View=new Int32Array(this.memory.buffer),this.ptrView=new Uint32Array(this.memory.buffer))}constructor(e,t,n){this.module=e,this.exports=t,this.memory=n,this.viewBuf=n.buffer,this.int32View=new Int32Array(n.buffer),this.ptrView=new Uint32Array(n.buffer)}}function tV(e,t){let n=e.weightsDirty||e.intersDirty;e.lastMemoryBuffer!==e.native.memory.buffer&&(e.lastMemoryBuffer=e.native.memory.buffer,n=!0),n&&(function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];s(O.Wte,0,t.vocabEmbed.weight,!0),s(O.Wpe,0,t.posEmbed.weight,!0),s(O.InputTokens,0,t.inputTokens),s(O.InputEmbed,0,t.add.output);for(let e=0;e<t.blocks.length;e++){let n=t.blocks[e];s(O.Ln1Gamma,e,n.ln_1.normWeight,!0),s(O.Ln1Beta,e,n.ln_1.normBias,!0),s(O.Ln1Agg,e,n.ln_1.normAgg),s(O.Ln1Norm,e,n.ln_1.output),s(O.AttnQkvW,e,n.attn.qkvWeight,!0),s(O.AttnQkvB,e,n.attn.qkvBias,!0),s(O.AttnQkv,e,n.attn.qkvOutput),s(O.Attn,e,n.attn.attnMatrix),s(O.AttnSmAgg,e,n.attn.attnMatrixAgg),s(O.AttnSm,e,n.attn.attnMatrixSoftmax),s(O.AttnVOut,e,n.attn.scaledVectors),s(O.AttnProjW,e,n.attn.proj.weight,!0),s(O.AttnProjB,e,n.attn.proj.bias,!0),s(O.AttnProj,e,n.attn.proj.output),s(O.AttnResidual,e,n.attn.output),s(O.Ln2Gamma,e,n.ln_2.normWeight,!0),s(O.Ln2Beta,e,n.ln_2.normBias,!0),s(O.Ln2Agg,e,n.ln_2.normAgg),s(O.Ln2Norm,e,n.ln_2.output),s(O.MlpW,e,n.mlp.fcLayer.weight,!0),s(O.MlpB,e,n.mlp.fcLayer.bias,!0),s(O.MlpProjW,e,n.mlp.projLayer.weight,!0),s(O.MlpProjB,e,n.mlp.projLayer.bias,!0),s(O.MlpMlp,e,n.mlp.fcLayer.output),s(O.MlpAct,e,n.mlp.mlpGelu),s(O.MlpProj,e,n.mlp.projLayer.output),s(O.MlpResidual,e,n.mlp.addLayer.output)}s(O.LnFGamma,0,t.ln_f.normWeight,!0),s(O.LnFBeta,0,t.ln_f.normBias,!0),s(O.LnFAgg,0,t.ln_f.normAgg),s(O.LnFNorm,0,t.ln_f.output),s(O.LmHeadW,0,t.lm_head.weight,!0),s(O.Logits,0,t.lm_head.output),s(O.LogitsSmAgg,0,t.softmaxFinal.agg),s(O.LogitsSm,0,t.softmaxFinal.output);let{T:o,vocabSize:i}=t.shape,a=t.softmaxFinal.output.localBuffer,l=new Float32Array(2*a.length);for(let e=0;e<o;e++){let t=[...a.slice(e*i,(e+1)*i)].map((e,t)=>({v:e,i:t}));t.sort((e,t)=>t.v-e.v);for(let n=0;n<t.length;n++)l[(e*i+n)*2+0]=t[n].i,l[(e*i+n)*2+1]=t[n].v}function s(o,i,a,l){let s=e.native.getModelTensor(e.modelPtr,o,i);(function(e,t,n){let r=n.height*n.width*n.channels;if(t.buffer.length!==r)throw Error("readToBufferTex: buffer size mismatch for ".concat(e,". ")+"bufferTex: ".concat(r," [h: ").concat(n.height,", w: ").concat(n.width,", c: ").concat(n.channels,"], ")+"wasmBuffer:  ".concat(t.buffer.length," [").concat(t.shape.join(", "),"]"));n.localBuffer=t.buffer})("".concat(O[o]).concat(i),s,a),(l?r:n)&&H(t.gl,a,a.localBuffer)}t.sortedBuf=l}(e,t,e.intersDirty,e.weightsDirty),e.weightsDirty=!1,e.intersDirty=!1)}(y=O||(O={}))[y.Wte=0]="Wte",y[y.Wpe=1]="Wpe",y[y.LmHeadW=2]="LmHeadW",y[y.AttnQkvW=3]="AttnQkvW",y[y.AttnQkvB=4]="AttnQkvB",y[y.AttnProjW=5]="AttnProjW",y[y.AttnProjB=6]="AttnProjB",y[y.MlpW=7]="MlpW",y[y.MlpB=8]="MlpB",y[y.MlpProjW=9]="MlpProjW",y[y.MlpProjB=10]="MlpProjB",y[y.Ln1Gamma=11]="Ln1Gamma",y[y.Ln1Beta=12]="Ln1Beta",y[y.Ln2Gamma=13]="Ln2Gamma",y[y.Ln2Beta=14]="Ln2Beta",y[y.LnFGamma=15]="LnFGamma",y[y.LnFBeta=16]="LnFBeta",y[y.InputTokens=17]="InputTokens",y[y.InputTokenEmbed=18]="InputTokenEmbed",y[y.InputEmbed=19]="InputEmbed",y[y.Ln1Agg=20]="Ln1Agg",y[y.Ln1Norm=21]="Ln1Norm",y[y.AttnQkv=22]="AttnQkv",y[y.Attn=23]="Attn",y[y.AttnSmAgg=24]="AttnSmAgg",y[y.AttnSm=25]="AttnSm",y[y.AttnVOut=26]="AttnVOut",y[y.AttnProj=27]="AttnProj",y[y.AttnResidual=28]="AttnResidual",y[y.Ln2Agg=29]="Ln2Agg",y[y.Ln2Norm=30]="Ln2Norm",y[y.MlpMlp=31]="MlpMlp",y[y.MlpAct=32]="MlpAct",y[y.MlpProj=33]="MlpProj",y[y.MlpResidual=34]="MlpResidual",y[y.LnFAgg=35]="LnFAgg",y[y.LnFNorm=36]="LnFNorm",y[y.Logits=37]="Logits",y[y.LogitsSmAgg=38]="LogitsSmAgg",y[y.LogitsSm=39]="LogitsSm";var tY=n(83754);function tG(e,t){return{name:e,shape:t,shapeString:JSON.stringify(t),isShapeStringValid:!0}}var tq=e=>{let{operand:t,onUpdate:n,onRemove:r}=e,[o,i]=(0,Y.useState)(t.shapeString),a=t.isShapeStringValid?{}:{color:"red",borderWidth:"2px"},l={border:"1px solid #007bff",borderRadius:"2px",padding:"4px 4px",margin:"1px 4px",outline:"none",boxShadow:"inset 0 1px 1px rgba(0, 0, 0, 0.1)",width:"100px",fontSize:"0.8rem",transition:"border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out"};return(0,V.jsxs)("div",{children:[(0,V.jsx)("input",{type:"text",value:t.name,onChange:e=>{n({...t,name:e.target.value})},placeholder:"Name",style:l}),(0,V.jsx)("input",{type:"text",className:"",value:t.shapeString,onChange:e=>{let r=e.target.value;i(r);let o=function(e){if(!(e=e.replace(/\s|\(|\)|\[|\]/g,"")))return null;let t=e.split(","),n=[];for(let e of t){if(!/^-?\d+$/.test(e))return null;n.push(parseInt(e,10))}return n}(r),a=!!o,l=a?o:t.shape;n({...t,shape:l,shapeString:r,isShapeStringValid:a})},placeholder:"Shape (e.g., 2,3)",style:{...l,...a}}),(0,V.jsx)("button",{onClick:r,children:" "})]})},tW=function(e){let{operands:t,equation:n,isEquationValid:r,onEquationChange:o,onAddOperand:i,onRemoveOperand:a,onUpdateOperand:l}=e,[s,c]=(0,Y.useState)(n);return(0,V.jsxs)("div",{children:[t.map((e,t)=>(0,V.jsx)(tq,{operand:e,onUpdate:e=>l(t,e),onRemove:()=>a(t)},t)),(0,V.jsx)("button",{onClick:i,className:"Commentary_btn__qpOgN  flex-[2] bg-blue-300 border border-blue-600 hover:bg-blue-400",children:(0,V.jsx)("div",{children:"Add Operand"})}),(0,V.jsx)("div",{children:(0,V.jsxs)("label",{children:["Equation:",(0,V.jsx)("input",{type:"text",value:n,style:r?{}:{color:"red",borderWidth:"2px"},onChange:e=>{let t=e.target.value;c(t),o(t)}})]})})]})};class tH{static fromArray(e){let t=function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!Array.isArray(t))return n;let r=t.length;n.push(r);for(let o=0;o<r;o++)if(Array.isArray(t[o])){let r=e(t[o]);if(n.length>1&&r.length+n.length-1!==n.length)throw Error("Non-uniform shape detected");if(r.length>0){n.push(...r);break}}return n}(e),n=new tH(t);return n.array=e,n}initArray(e){return 0===e.length?[]:Array.from({length:e[0]},()=>this.initArray(e.slice(1)))}getItem(e){return e.reduce((e,t)=>e[t],this.array)}setItem(e,t){e.reduce((n,r,o)=>o===e.length-1?(n[r]=t,t):n[r],this.array)}toString(){return JSON.stringify(this.array)}constructor(e){this.shape=e,this.array=this.initArray(e)}}function tQ(e,t){let n=e.map(e=>t[e]);return function e(t){if(0===t.length)return[[]];let n=e(t.slice(1));return[].concat(...Array.from({length:t[0]},(e,t)=>n.map(e=>[t].concat(e))))}(n)}function tK(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if("string"!=typeof e)return{valid:!1,reason:"Equation must be a string."};if(!Array.isArray(n))return{valid:!1,reason:"Shapes should be an array"};e.includes("->")||(e+="->");let[o,i]=e.split("->"),a=o.split(","),l=i.split(","),s=l[0];if(a.length!==n.length)return{valid:!1,reason:"Number of input dimensions does not match the number of provided shapes."};for(let e=0;e<n.length;e++)if(a[e].length!==n[e].length)return{valid:!1,reason:"Shape at index ".concat(e," does not match its corresponding subscript.")};let c=[...new Set(l.join(""))];if(c.length!==l.join("").length)return{valid:!1,reason:"Repeated subscripts in the output are not allowed."};for(let e=0;e<c.length;e++){let t=c[e],n=!1;for(let e of a)e.includes(t)&&(n=!0);if(!n)return{valid:!1,reason:"Output subscript '".concat(t,"' does not appear in the input.")}}let u={};a.forEach((e,t)=>{e.split("").forEach((e,r)=>{u[e]=n[t][r]})});let d={};for(let e=0;e<n.length;e++){let t=n[e];for(let n=0;n<t.length;n++){let r=a[e][n],o={opi:e,size:t[n]};r in d?d[r].push(o):d[r]=[o]}}for(let e in d){let t=d[e],n=t[0].size;for(let r=0;r<t.length;r++){let o=t[r];if(o.size!=n)return{valid:!1,reason:"Dimension '".concat(e,"' has mismatched sizes across operands. operands[0].shape=").concat(n," while operands[").concat(o.opi,"].shape=").concat(o.size)}}}let f=s.split(""),h=[...new Set([].concat(...a.map(e=>e.split(""))))].filter(e=>!f.includes(e)),m=f.map(e=>u[e]),p=0===m.length,x=p?0:new tH(m),g=f.concat(h);return tQ(f,u).forEach(e=>{let t=[];tQ(h,u).forEach(n=>{let r=e.concat(n),o=a.map((e,t)=>{let n=function(e,t,n){let r=Object.fromEntries(n.map((e,n)=>[e,t[n]]));return e.map(e=>r[e])}(e.split(""),r,g);return{operand_i:t,local_idx:n}});t.push(o)}),p?((x=new tH([1])).shape=[],x.array=t):x.setItem(e,t)}),{valid:!0,relmap:x,freeDims:f,dim2size:u,summationDims:h,inputDims:a}}function tZ(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];n=n.map(e=>e instanceof tH?e:tH.fromArray(e));let o=n.map(e=>e.shape),i=tK(e,...o);if(!i.valid)throw Error(i);let{relmap:a,freeDims:l,dim2size:s}=i;return function(e,t,n){for(var r=arguments.length,o=Array(r>3?r-3:0),i=3;i<r;i++)o[i-3]=arguments[i];let a=0===t.length,l=a?0:new tH(e.shape);return tQ(t,n).forEach(t=>{let n=a?e.array:e.getItem(t),r=0;n.forEach(e=>{let t=1;e.forEach(e=>{let{operand_i:n,local_idx:r}=e;t*=o[n].getItem(r)}),r+=t}),a?l=r:l.setItem(t,r)}),l}(a,l,s,...n)}function tJ(e,t){if(!e)throw Error(t||"Assertion failed")}function t$(e,t){if(e instanceof tH&&(e=e.array),t instanceof tH&&(t=t.array),!function e(t,n){if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(Array.isArray(t[r])&&Array.isArray(n[r])){if(!e(t[r],n[r]))return!1}else if(t[r]!==n[r])return!1;return!0}(e,t))throw Error("Arrays are not equal")}tZ("ij,kj->ij",[[1,2,3]],[[1,2,3],[1,2,3]]);let t0=tZ("i->",[1,2,3]);tJ(6==t0);let t1=tZ("i,i->",[1,2],[3,4]);function t2(e,t,n,r,o){let i="",a="";if(0===r.length)i+="R = 0\n";else{let e=r.map(e=>o[e]).join(", ");i+="R = zeros(shape=(".concat(e,"))\n")}for(let e of(a="",r)){let t=o[e];i+="".concat(a,"for ").concat(e," in range(").concat(t,"):\n"),a+="    "}i+=a+"total = 0\n";let l=a;for(let e of n){let t=o[e];i+="".concat(l,"for ").concat(e," in range(").concat(t,"):\n"),l+="    "}function s(e,t){"string"==typeof t&&(t=t.split(""));let n=t.join(",");return"".concat(e,"[").concat(n,"]")}let c=[];for(let n=0;n<t.length;n++)c.push(s(e[n],t[n]));let u=c.join(" * ");i+="".concat(l,"total += ").concat(u,"\n");let d=r.length>0?s("R",r):"R";return(i+="".concat(a).concat(d," = total")).trimEnd()}function t3(e){let t,n,r;let{equation:o,operands:i}=e,a=i.map(e=>e.shape),l="";try{let e=tK(o,...a);if(e.valid){let{dim2size:o,summationDims:a}=e;n=e.inputDims,r=e.freeDims,t=e.relmap;let s=i.map(e=>e.name);l=t2(s,n,a,r,o)}else l='raise ValueError("'.concat(e.reason,'")')}catch(e){l=""+e}return{relmap:t,displayPythonString:l,inputDims:n,freeDims:r}}function t4(e){let t;let{relmap:n,inputDims:r,freeDims:o}=t3(e);return n&&((t=tG("Result",n.shape)).relmap=n,t.freeDims=o,t.inputDims=r),t}tJ(11==t1),t$(tZ("i,i->i",[1,2],[3,4]),[3,8]),t$(tZ("i,j->i",[1,2],[3,4]),[7,14]),function(){let e=0,t=[{args:{operandNames:["A","B","C","D"],inputDims:["ia","jb","ab","ij"],summationDims:["a","b"],freeDims:["i","j"],dim2size:{i:8,j:16,a:42,b:12}},expected:"\nR = zeros(shape=(8, 16))\nfor i in range(8):\n    for j in range(16):\n        total = 0\n        for a in range(42):\n            for b in range(12):\n                total += A[i,a] * B[j,b] * C[a,b] * D[i,j]\n        R[i,j] = total\n"},{args:{operandNames:["A"],inputDims:["i"],summationDims:["i"],freeDims:[],dim2size:{i:8}},expected:"\nR = 0\ntotal = 0\nfor i in range(8):\n    total += A[i]\nR = total\n"},{args:{operandNames:["A","B"],inputDims:["i","j"],summationDims:["j"],freeDims:["i"],dim2size:{i:8,j:16}},expected:"\nR = zeros(shape=(8))\nfor i in range(8):\n    total = 0\n    for j in range(16):\n        total += A[i] * B[j]\n    R[i] = total\n"},{args:{operandNames:["A","B"],inputDims:["Bi","Bj"],summationDims:[],freeDims:["B","j","i"],dim2size:{B:32,i:8,j:12}},expected:"\nR = zeros(shape=(32, 12, 8))\nfor B in range(32):\n    for j in range(12):\n        for i in range(8):\n            total = 0\n            total += A[B,i] * B[B,j]\n            R[B,j,i] = total"},{args:{operandNames:["A"],inputDims:["i"],summationDims:[],freeDims:["i"],dim2size:{i:8}},expected:"\nR = zeros(shape=(8))\nfor i in range(8):\n    total = 0\n    total += A[i]\n    R[i] = total"}];for(let{args:n,expected:r}of t){r=r.slice(1);let t=t2(n.operandNames,n.inputDims,n.summationDims,n.freeDims,n.dim2size);console.log(n),t.trimEnd()===r.trimEnd()?(console.log(" Test passed"),console.log("Expected:"),console.log(r),e++):(console.log(" Test failed"),console.log("Expected:"),console.log(r),console.log("Received:"),console.log(t)),console.log("******************************")}console.log("Tests passed: ".concat(e," / ").concat(t.length))}();let t5=e=>{let{einsumProgramState:t,onStateChanged:n}=e,{equation:r,output:o,operands:i}=t,{relmap:a,displayPythonString:l}=t3(t);function s(e){let t={...e};t.output=t4(t),n(t)}if(!o){let e=t4(t);e||(e=tG("ERROR",[1,1,1,1])),n({...t,output:e})}return(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(tW,{operands:i,equation:r,isEquationValid:!!a,onEquationChange:e=>{s({...t,equation:e})},onAddOperand:()=>{let e=[...i,function(){let e="Q";if(i.length>0){let t=i[i.length-1].name;if(1===t.length){let n=t.charCodeAt(0);e=String.fromCharCode(n+1)}}return tG(e,[8,32])}()];s({...t,operands:e})},onRemoveOperand:e=>{let n=i.slice(0,e).concat(i.slice(e+1));s({...t,operands:n})},onUpdateOperand:(e,n)=>{let r=[...i.slice(0,e),n,...i.slice(e+1)];s({...t,operands:r})}}),(0,V.jsx)(tY.Z,{language:"python",children:l})]})},t6=[{name:"Multihead Query-Key Attention scores (similarity between each query and each key)",state:{equation:"Bnqh,Bnkh->Bnqk",operands:[tG("Q",[8,4,4,8]),tG("K",[8,4,12,8])]}},{name:"Quadratic form",state:{equation:"a,ab,b->",operands:[tG("x",[7]),tG("Symmetric Q",[7,7]),tG("x",[7])]}},{name:"Dot product",state:{equation:"i,i->",operands:[tG("A",[16]),tG("B",[16])]}},{name:"Outer product transposed",state:{equation:"i,j->ji",operands:[tG("A",[7]),tG("B",[22])]}},{name:"Matrix Multiplication",state:{equation:"ik,kj->ij",operands:[tG("A",[16,8]),tG("B",[8,12])]}},{name:"Return a diagonal",state:{equation:"ii->i",operands:[tG("A",[16,16])]}},{name:"Batched Matrix Multiplication",state:{equation:"Bik,Bkj->Bij",operands:[tG("A",[32,16,8]),tG("B",[32,8,12])]}},{name:"Custom",state:{equation:"abcdefg,h->he",operands:[tG("A",[2,2,2,2,2,3,3]),tG("B",[8])]}}],t8=e=>{let{children:t}=e,[n,r]=(0,Y.useState)(null),o=tU(),i=(0,Y.useCallback)(e=>{e(o),o.markDirty()},[o]);function a(e,t,n){let r=e.camAngle,o=e.camTarget.clone();o.z=o.z+.1*n*r.z;let a=Math.sin(r.x*Math.PI/180)>0?1:-1;o.x=o.x+a*t*.1*r.z,i(e=>{e.camera.center=o})}function l(e,t,n){let r=e.camAngle.clone();r.x=r.x-.5*t,r.y=er(r.y+.5*n,-87,87),i(e=>{e.camera.angle=r})}let[s,c]=eO(function(e,t){let n=e.clientX-t.clientX,r=e.clientY-t.clientY;t.shiftKey||1===t.button||2===t.button?l(t.data,n,r):a(t.data,n,r),e.preventDefault()});return(eN(n,{camAngle:o.camera.angle,camTarget:o.camera.center},{alwaysSendDragEvent:!0},function(e,t){let n=t.touches[0],r=e.touches[0],o=r.clientX-n.clientX,i=r.clientY-n.clientY;a(t.data,o,i),e.preventDefault()},function(e,t){let n,r=t.touches[0],o=t.touches[1],a=e.touches[0],s=e.touches[1],c=(r.clientX+o.clientX)/2,u=(r.clientY+o.clientY)/2,d=(a.clientX+s.clientX)/2,f=(a.clientY+s.clientY)/2,h=Math.sqrt((r.clientX-o.clientX)**2+(r.clientY-o.clientY)**2),m=Math.sqrt((a.clientX-s.clientX)**2+(a.clientY-s.clientY)**2);l(t.data,d-c,f-u),(n=t.data.camAngle.clone()).z=er(n.z/(m/h),.1,1e5),i(e=>{e.camera.angle=n}),e.preventDefault()}),o.render)?(0,V.jsx)("div",{ref:r,className:eE().canvasEventSurface,onMouseDown:function(e){o&&c(e,{camAngle:o.camera.angle,camTarget:o.camera.center})},onMouseMove:function(e){if(o){let t=o.render.canvasEl.getBoundingClientRect(),n=new K(e.clientX-t.left,e.clientY-t.top,0);i(e=>{e.mouse.mousePos=n})}},onWheel:function(e){if(o){let t=o.camera.angle,n=er(t.z*Math.pow(1.0013,e.deltaY),.01,1e5);i(e=>{e.camera.angle=new K(t.x,t.y,n)})}e.stopPropagation()},onContextMenu:e=>e.preventDefault(),style:{cursor:s?"grabbing":o.display.hoverTarget?"crosshair":"grab"},children:t}):null};(_=N||(N={}))[_.Up=0]="Up",_[_.Down=1]="Down",_[_.Left=2]="Left",_[_.Right=3]="Right",_[_.Focus=4]="Focus",_[_.In=5]="In",_[_.Out=6]="Out",_[_.Expand=7]="Expand",(b=X||(X={}))[b.MainPage=0]="MainPage",b[b.Element=1]="Element",b[b.Modal=2]="Modal";let t9=(0,Y.createContext)(new class{registerHandler(e,t,n){var r;let o={order:e,handler:t,receiveKeyUp:null!==(r=null==n?void 0:n.receiveKeyUp)&&void 0!==r&&r};return this.handlers.push(o),()=>{this.handlers=this.handlers.filter(e=>e!==o)}}constructor(){this.handlers=[],this.handleKey=e=>{let t=this.handlers.sort((e,t)=>e.order-t.order),n=!1,r=e.stopPropagation;for(let o of(e.stopPropagation=()=>{n=!0,r.call(e)},t))if(("keyup"!==e.type||o.receiveKeyUp)&&(o.handler(e),n))break}}});(w=j||(j={}))[w.None=0]="None",w[w.Alt=1]="Alt",w[w.CtrlOrCmd=2]="CtrlOrCmd",w[w.Shift=4]="Shift";var t7=n(57042);let ne=e=>{let{id:t,className:n,children:r,vertical:o,defaultFraction:i}=e,[a,l]=(0,Y.useState)(null),[s,c]=(0,Y.useState)(null),u=Y.Children.toArray(r).filter(e=>e),d=u[0],f=u[1],[h,m]=(0,Y.useState)(null!=i?i:.4),[,p]=function(e,t,n,r){let[o,i]=(0,Y.useState)(null),a=eL(t);eN(e,0,{alwaysSendDragEvent:!0,sendDragEnd:!0},function(e,r,a){var l;let s=ej(e,eV(e.touches[0])),c=o;if(!c){let e=t(s);i(c={...eV(r.touches[0]),data:e})}r.isDragging&&(n(s,c,a),a&&i(null))},void 0,function(e,t){if(o){var n;null==r||r(ej(e,eV(e.touches[0])),o)}i(null)});let[l,s]=eO(function(e,t,r){n(e,t,r)},r?function(e,t){null==r||r(e,t)}:void 0);return[null!=l?l:o,(0,Y.useCallback)(e=>{let t=a.current(e);s(e,t)},[s,a])]}(s,()=>h,(e,t,n)=>{let r=a.getBoundingClientRect(),i=o?e.clientY-t.clientY:e.clientX-t.clientX,l=o?r.height:r.width;m(er(t.data+i/l,0,1)),e.preventDefault(),e.stopPropagation()}),x=100*h+"%",g=(1-h)*100+"%",v=d&&f;return(0,V.jsxs)("div",{ref:l,className:(0,t7.Z)("relative flex",n,o?"flex-col":"flex-row"),children:[d&&(0,V.jsx)("div",{className:"flex flex-initial overflow-hidden",style:{flexBasis:v?x:"100%"},children:d}),f&&(0,V.jsx)("div",{className:"flex flex-initial overflow-hidden",style:{flexBasis:v?g:"100%"},children:f}),v&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)("div",{ref:c,className:(0,t7.Z)("absolute",o?"w-full cursor-ns-resize h-4":"h-full cursor-ew-resize w-4"),style:{transform:"translate".concat(o?"Y":"X","(-50%)"),top:o?x:void 0,left:o?void 0:x},onMouseDown:function(e){p(e),e.stopPropagation(),e.preventDefault()}}),(0,V.jsx)("div",{className:(0,t7.Z)("absolute bg-slate-200 pointer-events-none",o?"w-full h-0 border-t":"h-full w-0 border-l"),style:{transform:"translate".concat(o?"Y":"X","(-50%)"),top:o?x:void 0,left:o?void 0:x}})]})]})};var nt=n(72759);let nn=()=>{let e=tU();return(0,V.jsxs)("div",{className:"absolute top-0 left-0 flex flex-col",children:[(0,V.jsx)("div",{className:"mt-2 ml-2 flex flex-row"}),(0,V.jsxs)("div",{className:"ml-2 flex flex-row",children:[(0,V.jsx)("div",{className:(0,t7.Z)("m-2 p-2 bg-white min-w-[2rem] flex justify-center rounded shadow cursor-pointer hover:bg-blue-300"),onClick:function(){var t;let n=null!==(t=e.examples[e.currExampleId])&&void 0!==t?t:e.mainExample;e.camera.desiredCamera=n.camera,e.markDirty()},children:(0,V.jsx)(tC.G,{icon:nt.TL5})}),(0,V.jsx)("div",{className:(0,t7.Z)("m-2 p-2 bg-white min-w-[2rem] flex justify-center rounded shadow cursor-pointer hover:bg-blue-300"),onClick:function(){var t,n;let r=null!==(t=e.examples[e.currExampleId])&&void 0!==t?t:e.mainExample,o=null!==(n=r.layout)&&void 0!==n?n:e.layout,i=o.cubes[o.cubes.length-1],a=new K(i.x,i.y,i.z),l=e.camera.modelMtx.mul(eT.fromTranslation(r.offset)).mulVec3Proj(a),s=-1===e.currExampleId?.7:4;e.camera.desiredCamera={center:l,angle:new K(270,4.5,s)},e.markDirty()},children:(0,V.jsx)(tC.G,{icon:nt.Y$T})})]})]})};var nr=n(2008),no=n.n(nr),ni=e=>{let{texts:t,selectedIndex:n,onEntryClick:r}=e;return(0,V.jsx)("ul",{style:{listStyleType:"none",padding:0},children:t.map((e,t)=>(0,V.jsx)("li",{style:{padding:"10px 15px",cursor:"pointer",backgroundColor:n===t?"#ADD8E6":"transparent",border:"1px solid #ddd",borderTopWidth:0===t?"1px":"0",fontWeight:n===t?"bold":"normal"},onClick:()=>r(t),children:e},t))})};let na=()=>{let e=tU(),{einsumStates:t,currentEinsumState:n}=e,{state:r,name:o}=t[n],i=t.map(e=>e.name);return V.Fragment,no().topSplit,no().toc,(0,V.jsx)("div",{className:no().walkthrough,children:(0,V.jsx)("div",{className:no().split,children:(0,V.jsxs)("div",{className:no().content,children:[(0,V.jsx)(ni,{texts:i,selectedIndex:n,onEntryClick:function(t){e.currentEinsumState=t,e.markDirty()}}),(0,V.jsx)(t5,{einsumProgramState:r,onStateChanged:function(r){let i=[...t.slice(0,n),{name:o,state:r},...t.slice(n+1)];e.einsumStates=i,e.markDirty()}})]})})})};async function nl(e){let t=await fetch(e),n=await t.json();for(let e in n)n[e].shape&&(n[e]=eC.fromJson(n[e]));return n}function ns(){var e,t,n,r;let o,i,a,l,[s,c]=(0,Y.useState)(null),[u,d]=(0,Y.useState)(null),[f,h]=(0,Y.useState)(null),[m,p]=(0,Y.useState)(null),x=function(){let[e,t]=(0,Y.useState)({width:0,height:0,isDesktop:!0,isPhone:!1});return(0,Y.useEffect)(()=>{let e=window.matchMedia("screen and (max-width: 800px)");function n(){t({width:window.innerWidth,height:window.innerHeight,isDesktop:!e.matches,isPhone:e.matches})}return n(),window.addEventListener("resize",n),e.addEventListener("change",n),()=>{window.removeEventListener("resize",n),e.removeEventListener("change",n)}},[]),e}(),g=(0,Y.useContext)(t9);e=X.MainPage,o=(0,Y.useContext)(t9),i=eL(e=>{if(!(null==f?void 0:f.progState))return;let t=e.key.toLowerCase(),n=f.progState.walkthrough,r=f.progState.movement;" "===e.key&&(n.time>=n.phaseLength?(function(e,t){let n=e.phaseList.find(t=>t.phases.find(t=>t.id===e.phase)),r=e.phaseList.indexOf(n),o=n.phases.findIndex(t=>t.id===e.phase)+1;if(o<0){if(r>0){let t=e.phaseList[r-1];e.phase=t.phases[t.phases.length-1].id}}else if(o>=n.phases.length){if(r<e.phaseList.length-1){let t=e.phaseList[r+1];e.phase=t.phases[0].id}}else e.phase=n.phases[o].id;console.log("new phase is ".concat(S[e.phase])),e.time=0,e.running=!1}(n,0),n.time=0):n.running=!n.running,f.markDirty()),("Backspace"===e.key||"Delete"===e.key)&&(n.running=!1,n.time=0,f.markDirty()),("ArrowLeft"===e.key||"a"===t)&&(r.action=N.Left,f.markDirty()),("ArrowRight"===e.key||"d"===t)&&(r.action=N.Right,f.markDirty()),("ArrowUp"===e.key||"w"===t)&&(r.action=N.Up,f.markDirty()),("ArrowDown"===e.key||"s"===t)&&(r.action=N.Down,f.markDirty()),("PageUp"===e.key||"q"===t)&&(r.action=N.In,f.markDirty()),("PageDown"===e.key||"e"===t)&&(r.action=N.Out,f.markDirty()),"r"===t&&(r.action=N.Expand,f.markDirty()),"f"===t&&(r.action=N.Focus,f.markDirty())," "===e.key&&e.preventDefault()}),a=null!==(n=null==t?void 0:t.receiveKeyUp)&&void 0!==n&&n,l=null===(r=null==t?void 0:t.isActive)||void 0===r||r,(0,Y.useEffect)(()=>{if(l){let t=o.registerHandler(e,e=>i.current(e),{receiveKeyUp:a});return()=>t()}},[e,i,o,a,l]),(0,Y.useEffect)(()=>(document.addEventListener("keydown",g.handleKey),()=>{document.removeEventListener("keydown",g.handleKey)}),[g]),(0,Y.useEffect)(()=>{let e=!1;return async function(){let t=nl("gpt-nano-sort-t0-partials.json"),n=nl("gpt-nano-sort-model.json"),r=tX(),[o,i,a]=await Promise.all([t,n,r]);e||d({data:o,model:i,native:a})}(),()=>{e=!0}},[]),(0,Y.useEffect)(()=>{let e=!1;return async function(){let t=await eD();e||p(t)}(),()=>{e=!0}},[]),(0,Y.useEffect)(()=>{if(s&&m){let e=new nc(s,null,m),t=new ResizeObserver(()=>{e.canvasSizeDirty=!0,e.markDirty()}),n=e=>e.preventDefault();return h(e),t.observe(s),s.addEventListener("wheel",n,{passive:!1}),()=>{s.removeEventListener("wheel",n),e.destroy(),t.disconnect()}}h(null)},[s,m]),(0,Y.useEffect)(()=>{null==f||f.setData({dataAndModel:u})},[f,u]),(0,Y.useLayoutEffect)(()=>{f&&(f.progState.pageLayout=x,f.markDirty())},[f,x]);let v=f&&(0,V.jsx)("div",{className:eE().sidebar,children:(0,V.jsx)(tL.Provider,{value:f.progState,children:(0,V.jsx)(na,{})})}),y=(0,V.jsxs)("div",{className:eE().canvasWrap,children:[(0,V.jsx)("canvas",{className:eE().canvas,ref:c}),f&&!f.progState.render&&(0,V.jsxs)("div",{className:"absolute flex flex-col items-center w-full h-full justify-center",children:[(0,V.jsx)("div",{className:"text-2xl",children:"This application requires a WebGL2 capable browser."}),(0,V.jsx)("div",{className:"text-lg mt-2",children:"Please try the latest version of Chrome or Firefox."})]}),f&&(0,V.jsxs)(tL.Provider,{value:f.progState,children:[(0,V.jsx)(t8,{}),(0,V.jsx)(nn,{})]})]});return(0,V.jsx)("div",{className:eE().view,children:(0,V.jsxs)(ne,{id:"llm-sidebar",className:"flex-1",vertical:!x.isDesktop,defaultFraction:.4,children:[x.isDesktop&&v,y,!x.isDesktop&&v]})})}class nc{destroy(){this.stopped=!0}setData(e){if(this.canvasData=e,e.dataAndModel&&!this.progState.gptGpuModel&&this.progState.render){var t,n;this.progState.gptGpuModel=(t=this.renderState,n=e.dataAndModel,function(e,t,n){let r=e.gl,o="transformer",i=t.config,a=i.n_embd,l=i.n_head,s=i.block_size,c=i.n_layer,u=i.vocab_size,d={B:n,C:a,nHeads:l,T:s,A:a/l,nBlocks:c,vocabSize:u},f={gl:r,model:t,shape:d,shaderManager:e},h=new Float32Array(n*s),m=W(r,1,n*s,1),p=new Float32Array(n*s);for(let e=0;e<n;e++)for(let t=0;t<s;t++)p[e*s+t]=t;let x=W(r,1,n*s,1);H(r,x,p);let g=eb(f,o+".wte",u,a,m),v=eb(f,o+".wpe",s,a,x),y=ew(f,g.output,v.output),_=[],b=y.output;for(let e=0;e<c;e++){let t=function(e,t,n){let r=ey(e,t+".ln_1",n),o=function(e,t,n,r){let{gl:o,model:i,shape:{B:a,T:l,C:s,nHeads:c,A:u},shaderManager:d}=e,f=i[t+".c_attn.weight"].view([3,c,u,s]).permute(1,2,3,0),h=i[t+".c_attn.bias"].view([3,c,u]).permute(1,2,0),m=W(o,s,c*u,3),p=W(o,1,c*u,3),x=W(o,u,a*c*l,4),g=W(o,l,a*c*l,1),v=W(o,1,a*c*l,2),y=W(o,l,a*c*l,1),_=W(o,c*u,a*l,1);H(o,m,f.toFloat32Array()),H(o,p,h.toFloat32Array());let b=el(d,"qkv",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnInput; // (B, T)         (C)\n        uniform sampler2D qkvWeight; // (nHeads, A)    (C) [3]\n        uniform sampler2D qkvBias;   // (nHeads, A)    (1) [3]\n        out vec4 qkvOutput;          // (B, nHeads, T) (A)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int headIdx = pos.y / ".concat(l,";\n            int tIdx = pos.y % ").concat(l,";\n            int bIdx = headIdx / ").concat(c,";\n            headIdx = headIdx % ").concat(c,";\n\n            vec3 a = texelFetch(qkvBias, ivec2(0, headIdx * ").concat(u," + pos.x), 0).rgb;\n            for (int i = 0; i < ").concat(s,"; i++) {\n                float inVal = texelFetch(attnInput, ivec2(i, tIdx + bIdx * ").concat(l,"    ), 0).r;\n                vec3 qkvW   = texelFetch(qkvWeight,  ivec2(i, headIdx * ").concat(u," + pos.x), 0).rgb;\n                a += inVal * qkvW;\n            }\n\n            qkvOutput = vec4(a, 1);\n        }\n    ")),w=el(d,"selfAttend",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D qkvOutput; // (B, nHeads, T) (A)\n        out float attnMatrix;        // (B, nHeads, T) (T)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxK = pos.x;\n            int tIdxQ = pos.y % ".concat(l,";\n            int yOffset = pos.y - tIdxQ;\n\n            if (tIdxK > tIdxQ) { // # forward attention only\n                discard;\n            }\n\n            float a = 0.0;\n            for (int i = 0; i < ").concat(u,"; i++) {\n                float q = texelFetch(qkvOutput, ivec2(i, yOffset + tIdxQ), 0).r;\n                float k = texelFetch(qkvOutput, ivec2(i, yOffset + tIdxK), 0).g;\n                a += q * k;\n            }\n\n            attnMatrix = a / sqrt(float(").concat(u,"));\n        }\n    ")),A=el(d,"attnMatrixAgg",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnMatrix; // (B, nHeads, T) (T)\n        out vec2 attnMatrixAgg;       // (B, nHeads, T) (1) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxY = pos.y % ".concat(l,";\n\n            // Pass 1 finds the max\n            float m = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float p = texelFetch(attnMatrix, ivec2(i, pos.y), 0).r;\n                m = max(m, p);\n            }\n\n            // Pass 2 finds the exp sum (shifted by max)\n            float a = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float p = texelFetch(attnMatrix, ivec2(i, pos.y), 0).r;\n                a += exp(p - m);\n            }\n\n            // Store sufficient information to compute/apply the softmax\n            attnMatrixAgg = vec2(1.0 / a, m);\n        }\n    ")),E=el(d,"attnMatrixSoftmax",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D attnMatrix;    // (B, nHeads, T) (T)\n        uniform sampler2D attnMatrixAgg; // (B, nHeads, T) (1) [2]\n        out float attnMatrixSoftmax;     // (B, nHeads, T) (T)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxX = pos.x;\n            int tIdxY = pos.y % ".concat(l,";\n\n            if (tIdxX > tIdxY) { // # forward attention only\n                attnMatrixSoftmax = 0.0;\n                discard;\n            }\n\n            vec2 agg = texelFetch(attnMatrixAgg, ivec2(0, pos.y), 0).rg;\n            float expSumInv = agg.r;\n            float maxVal = agg.g;\n\n            float p = texelFetch(attnMatrix, pos, 0).r;\n            attnMatrixSoftmax = exp(p - maxVal) * expSumInv;\n        }\n    ")),T=el(d,"scaledVectors",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D qkvOutput;         // (B, nHeads, T) (A)\n        uniform sampler2D attnMatrixSoftmax; // (B, nHeads, T) (T)\n        out float scaledVectors;             // (B, T)         (A * nHeads)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int aIdx = pos.x % ".concat(u,";\n            int headIdx = pos.x / ").concat(u,";\n\n            int tIdxY = pos.y % ").concat(l,";\n            int bIdx = pos.y / ").concat(l,";\n\n            int yOffset = bIdx * ").concat(l," * ").concat(c," + headIdx * ").concat(l,";\n\n            float res = 0.0;\n            for (int i = 0; i <= tIdxY; i++) {\n                float sm = texelFetch(attnMatrixSoftmax, ivec2(i, yOffset + tIdxY), 0).r;\n                float v = texelFetch(qkvOutput, ivec2(aIdx, yOffset + i), 0).b;\n                res += sm * v;\n            }\n\n            scaledVectors = res;\n        }\n    "));if(!b||!w||!A||!E||!T)throw Error("Failed to create shader program");let z=q(o,b,[x],[n,m,p],["attnInput","qkvWeight","qkvBias"]),R=q(o,w,[g],[x],["qkvOutput"]),B=q(o,A,[v],[g],["attnMatrix"]),M=q(o,E,[y],[g,v],["attnMatrix","attnMatrixAgg"]),D=q(o,T,[_],[x,y],["qkvOutput","attnMatrixSoftmax"]),F=e_(e,t+".c_proj",s,s,_),I=ew(e,F.output,r);return{qkvWeight:m,qkvBias:p,qkvOutput:x,attnMatrix:g,attnMatrixAgg:v,attnMatrixSoftmax:y,scaledVectors:_,qkvPhase:z,selfAttendPhase:R,attnMatrixAggPhase:B,attnMatrixSoftmaxPhase:M,scaledVectorsPhase:D,proj:F,add:I,output:I.output}}(e,t+".attn",r.output,n),i=ey(e,t+".ln_2",o.output),a=function(e,t,n,r){let{gl:o,shape:{B:i,T:a,C:l},shaderManager:s}=e,c=W(o,4*l,i*a,1),u=el(s,"mlpGelu",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D geluInput;  // (B, T) (C * 4)\n        out float geluOutput; // (B, T) (C * 4)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            float x = texelFetch(geluInput, pos, 0).r;\n            geluOutput = x * 0.5 * (1.0 + tanh(sqrt(2.0 / 3.14159265358) * (x + 0.044715 * x * x * x)));\n        }\n    "),d=e_(e,t+".c_fc",l,4*l,n),f=q(o,u,[c],[d.output],["geluInput"]),h=e_(e,t+".c_proj",4*l,l,c),m=ew(e,h.output,r);return{fcLayer:d,mlpGelu:c,geluPhase:f,projLayer:h,addLayer:m,output:m.output}}(e,t+".mlp",i.output,o.output);return{attn:o,ln_1:r,ln_2:i,mlp:a,output:a.output}}(f,o+".h."+e,b);_.push(t),b=t.output}let w=ey(f,o+".ln_f",b),A=e_(f,"lm_head",a,u,w.output,void 0,!1),E=function(e,t){let{gl:n,shape:{B:r,T:o,C:i,vocabSize:a},shaderManager:l}=e,s=W(n,1,r*o,2),c=W(n,a,r*o,1),u=el(l,"softmaxAgg",ev,"#version 300 es\n        precision highp float;       //    y      x\n        uniform sampler2D smInput;   // (B, T) (nVocab)\n        out vec2 smAgg;              // (B)    (nVocab) [2]\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxY = pos.y % ".concat(o,";\n\n            // Pass 1 finds the max\n            float m = 0.0;\n            for (int i = 0; i < ").concat(a,"; i++) {\n                float p = texelFetch(smInput, ivec2(i, pos.y), 0).r;\n                m = max(m, p);\n            }\n\n            // Pass 2 finds the exp sum (shifted by max)\n            float a = 0.0;\n            for (int i = 0; i < ").concat(a,"; i++) {\n                float p = texelFetch(smInput, ivec2(i, pos.y), 0).r;\n                a += exp(p - m);\n            }\n\n            // Store sufficient information to compute/apply the softmax\n            smAgg = vec2(1.0 / a, m);\n        }\n    ")),d=el(l,"softmax",ev,"#version 300 es\n        precision highp float;\n        uniform sampler2D smInput;    // (B, T) (nVocab)\n        uniform sampler2D smAgg;      // (B)    (nVocab) [2]\n        out float smOutput;           // (B, T) (nVocab)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n            int tIdxX = pos.x;\n            int tIdxY = pos.y % ".concat(o,";\n\n            vec2 agg = texelFetch(smAgg, ivec2(0, pos.y), 0).rg;\n            float expSumInv = agg.r;\n            float maxVal = agg.g;\n\n            float p = texelFetch(smInput, pos, 0).r;\n            smOutput = exp(p - maxVal) * expSumInv;\n        }\n    ")),f=q(n,u,[s],[t],["smInput"]),h=q(n,d,[c],[t,s],["smInput","smAgg"]);return{bufs:[s,c],progs:[u,d],phases:[f,h],agg:s,aggPhase:f,softmaxPhase:h,output:c}}(f,A.output),T=function(e,t,n){let{gl:r,shape:{T:o,vocabSize:i},shaderManager:a}=e;return{copyPhase:q(r,el(a,"copy",ev,"#version 300 es\n        precision highp float;         //    y    x\n        uniform sampler2D prevOutput;  // (B, T) (n_vocab)\n        uniform int u_targetTIdx;\n        out float currInput;           // (B, T) (1)\n\n        void main() {\n            ivec2 pos = ivec2(gl_FragCoord.xy);\n\n            int tIdx = pos.y % ".concat(o,";\n\n            if (tIdx != u_targetTIdx) {\n                discard;\n            }\n\n            int maxVocabI = 0;\n            float maxVocabP = 0.0;\n            for (int i = 0; i < ").concat(i,"; i++) {\n                float p = texelFetch(prevOutput, ivec2(i, pos.y), 0).r;\n                if (p > maxVocabP) {\n                    maxVocabP = p;\n                    maxVocabI = i;\n                }\n            }\n\n            currInput = float(maxVocabI);\n        }\n    ")),[n],[t],["prevOutput"])}}(f,E.output,m);return es(e),{gl:r,inputBuf:h,inputTokens:m,vocabEmbed:g,posEmbed:v,add:y,blocks:_,ln_f:w,lm_head:A,shape:d,softmaxFinal:E,copyOutputToInput:T,output:E.output,inputLen:6,resultBuf:null,sortedBuf:null,readbackSync:null}}(t.ctx.shaderManager,n.model,1)),this.progState.native=e.dataAndModel.native,this.progState.wasmGptModel=function(e,t,n){let r=n.createModel(t);i("transformer.wte.weight",O.Wte),i("transformer.wpe.weight",O.Wpe),i("lm_head.weight",O.LmHeadW),o("transformer.ln_f",O.LnFGamma,O.LnFBeta);for(let e=0;e<t.n_layer;e++){let t="transformer.h.".concat(e);o(t+".ln_1",O.Ln1Gamma,O.Ln1Beta,e),o(t+".ln_2",O.Ln2Gamma,O.Ln2Beta,e),o(t+".attn.c_attn",O.AttnQkvW,O.AttnQkvB,e),o(t+".attn.c_proj",O.AttnProjW,O.AttnProjB,e),o(t+".mlp.c_fc",O.MlpW,O.MlpB,e),o(t+".mlp.c_proj",O.MlpProjW,O.MlpProjB,e)}function o(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(e+".weight",t,r),i(e+".bias",n,r)}function i(t,o){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e[t]?n.getModelTensor(r,o,i).copyFrom(e[t]):console.log("ERROR: missing tensor name:",t)}n.getModelTensor(r,O.InputTokens).buffer.set([2,1,0,1,1,2,0,0,0,0,0]);{let e=performance.now();n.runModel(r),console.log("runModel",(performance.now()-e).toFixed(2)+"ms")}return{native:n,modelPtr:r,lastMemoryBuffer:null,weightsDirty:!0,intersDirty:!0}}(e.dataAndModel.model,e.dataAndModel.model.config,e.dataAndModel.native)}this.markDirty()}checkSyncObjects(){if(!this.progState.render)return;let e=this.renderState.gl,t=this.progState.render.syncObjects,n=!1;for(let r=0;r<t.length;r++){let o=t[r];if(o.isReady){n=!0;continue}e.clientWaitSync(o.sync,0,0)===e.TIMEOUT_EXPIRED?this.isWaitingForSync=!0:(o.isReady=!0,o.elapsedMs=performance.now()-o.startTime,e.deleteSync(o.sync),n=!0)}n&&(this.progState.render.syncObjects=t.filter(e=>!e.isReady),this.markDirty())}render(e,t){if(!this.progState.render)return;let n=this.renderState.canvasEl;if(this.canvasSizeDirty){let e=n.getBoundingClientRect(),t=window.devicePixelRatio;n.width=e.width*t,n.height=e.height*t,this.progState.render.size=new K(e.width,e.height),this.canvasSizeDirty=!1}!function(e,t){var n,r,o,i;let a=performance.now();if(!t.render)return;eh((r=(n=t.render).lineRender).floatBuf),eg(r.indexBuf),eh((o=n.modelFontBuf).vertBuffer),o.segmentsUsed=0,eg((i=n.triRender).ibo),eh(i.vbo),t.render.sharedRender.activePhase=R.Opaque,t.display.lines=[],t.display.hoverTarget=null,t.display.tokenColors=null,t.display.tokenIdxColors=null,t.wasmGptModel&&t.jsGptModel&&tV(t.wasmGptModel,t.jsGptModel),t.stepModel&&t.wasmGptModel&&t.jsGptModel&&(t.stepModel=!1,function(e,t){let{native:n,modelPtr:r}=e,{shape:{B:o,T:i,vocabSize:a}}=t,l=t.inputLen-1;if(!t.sortedBuf||l>=i-1)return;let s=n.getModelTensor(r,O.InputTokens);for(let e=0;e<o;e++){let n=t.sortedBuf[e*i*a*2+l*a*2+0];s.buffer[e*i+l+1]=n}t.inputLen+=1,n.runModel(r),e.intersDirty=!0,tV(e,t)}(t.wasmGptModel,t.jsGptModel)),t.layout=tO(t),function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:K.zero,{camera:r}=e,o=new $;for(let e of t.cubes){let t=new K(e.x,e.y,e.z).add(n),r=new K(e.x+e.dx,e.y+e.dy,e.z+e.dz).add(n);o.addInPlace(t),o.addInPlace(r)}o.size().len();let{lookAt:i,camPos:a}=e4(r);r.angle.z;let l=eT.fromPersp(40,e.render.size.x/e.render.size.y,100,1e7).mul(i),s=new eT;s[0]=1,s[5]=0,s[6]=-1,s[9]=-1,s[10]=0,e.camera.modelMtx=s,e.camera.viewMtx=l,e.camera.camPos=a,e.camera.camPosModel=s.invert().mulVec3Affine(a),e.camera.lookAtMtx=i}(t,t.layout),function(e,t){let n=e.camera.desiredCameraTransition;if(n){if(n.t<1){n.t=er(n.t+t.dt/1e3*1.5,0,1);let r=n.initialPos,o=n.targetPos;e.camera.angle=r.angle.lerp(o.angle,n.t),e.camera.center=r.center.lerp(o.center,n.t),t.markDirty()}else e.camera.desiredCameraTransition=void 0}e.camera.desiredCamera&&(e.camera.desiredCameraTransition={t:0,initialPos:{center:e.camera.center,angle:e.camera.angle},targetPos:e.camera.desiredCamera},e.camera.desiredCamera=void 0,t.markDirty())}(t,e);let l=function(e,t){if(!e.ctx.ext.disjointTimerQuery)return null;let n=e.queries.get(t);if(!n){let r=e.ctx.gl.createQuery();e.queries.set(t,n={query:r,hasRun:!1,hasStarted:!1})}let r=!1;n.hasRun&&(r=e.ctx.gl.getQueryParameter(n.query,e.ctx.gl.QUERY_RESULT_AVAILABLE));let o=null;return r&&(o=e.ctx.gl.getQueryParameter(n.query,e.ctx.gl.QUERY_RESULT)/1e6),(!n.hasRun||r)&&(e.ctx.gl.beginQuery(e.TIME_ELAPSED_EXT,n.query),n.hasRun=!0,n.hasStarted=!0),o}(t.render.queryManager,"render");en(l)&&(t.render.lastGpuMs=l),t.render.renderTiming=!1,function(e){for(let t of e.layout.cubes){let n=new K(t.x+t.dx/2,t.y,t.z+t.dz/2),r=e5(e,n);r=Math.min(r,1.45);let o=new Z(1,1,1,1).mul(t.opacity),i=new Z(0,0,0,1).mul(t.opacity);if(0===t.opacity||!t.name)continue;let a=t.name,l=eT.fromTranslation(n),s={color:o,size:2.5*r,mtx:l},c=eI(e.render.modelFontBuf,a,s);e.render.sharedRender.activePhase=R.Opaque,tM(e.render,new K(-c/2-.4,-s.size-.8,0),new K(c/2+.4,0,0),i,l,.4*r),e.render.sharedRender.activePhase=R.Overlay,eP(e.render.modelFontBuf,a,-c/2,-s.size-.4,s)}}(t),function(e){let t=e.mouse,n=e.render.size,r=t.mousePos.x/n.x*2-1,o=1-t.mousePos.y/n.y*2,i=e.camera.viewMtx.invert(),a=e.camera.modelMtx.invert();function l(e){let t=i.mulVec4(e);return a.mulVec4(t).projToVec3()}let s=new Z(r,o,-1,1),c=new Z(r,o,1,1),u=l(s),d=l(c).sub(u).normalize(),f=[];for(let t of e.layout.cubes)!function e(t,n){if(t.subs)for(let r of t.subs)e(r,n||t);else t.opacity>0&&f.push([t,n])}(t,t);let h=0,m=null;for(let[e,t]of f){let n=function(e,t,n,r){let o=(e.x-n.x)/r.x,i=(t.x-n.x)/r.x,a=Math.min(o,i),l=Math.max(o,i),s=(e.y-n.y)/r.y,c=(t.y-n.y)/r.y;a=Math.max(a,Math.min(s,c)),l=Math.min(l,Math.max(s,c));let u=(e.z-n.z)/r.z,d=(t.z-n.z)/r.z;return a=Math.max(a,Math.min(u,d)),(l=Math.min(l,Math.max(u,d)))>=a?a:-1}(new K(e.x,e.y,e.z),new K(e.x+e.dx,e.y+e.dy,e.z+e.dz),u,d);n>0&&(!m||n<h)&&(h=n,m=[e,t])}if(m){let[t,n]=m,r=new K(t.x,t.y,t.z),o=u.add(d.mul(h)),i=new K(er((o.x-r.x)/t.dx,0,1-.1/t.cx),er((o.y-r.y)/t.dy,0,1-.1/t.cy),er((o.z-r.z)/t.dz,0,1-.1/t.cz)),a=t.localMtx?t.localMtx.mulVec3Proj(i):i,l=new K(Math.floor(a.x*t.cx),Math.floor(a.y*t.cy),Math.floor(a.z*t.cz));for(let r of(e.display.hoverTarget={mainCube:n,subCube:t,mainIdx:l},e.layout.labels))for(let e of r.cubes)e===n&&(r.visible=1);e6(e,e.layout,n,z.X,n.dimX,1),e6(e,e.layout,n,z.Y,n.dimY,1),function(e,t,n,r){if(tP(t,e=>{e.highlight=.1}),n===t){let o=new K(r.x*n.cx*n.dx/t.dx,r.y*n.cy*n.dy/t.dy,r.z*n.cz*n.dz/t.dz),i=tr(e.layout,n,z.X,o.x,0);if(i){i.highlight=.15;let t=tr(e.layout,i,z.Y,o.y,0);if(t){let n=tr(e.layout,t,z.Z,o.z,0);n&&(n.highlight=.6)}}}}(e,n,t,i),function(e,t,n){let r=e.layout,o=t.deps;function i(e,t){let n=tn(r,e,z.X,t.x);n&&(n=tn(r,n,z.Y,t.y))&&(n=tn(r,n,z.Z,t.z))&&(n.highlight=1.5)}if(o){if(o.dot){let a=tS(t,n);for(let l of o.dot)!function(n,o,a){var l,s;let{srcIdx:c,dotDim:u,otherDim:d,isDot:f}=tk(n,o);if((null===(l=t.deps)||void 0===l?void 0:l.special)===D.InputEmbed&&n.src===e.layout.tokEmbedObj){let t=tB(e.layout.idxObj,new K(o.x,0,o.z));f=!1,c.setAt(z.X,null!=t?t:0)}if(f){(null===(s=n.src.deps)||void 0===s?void 0:s.lowerTri)&&(a=null!=a?a:c.getAt(u));let e=tn(r,n.src,u,c.getAt(u));if(e&&en(a))for(let t of(tr(r,e,d,a,0),function(e,t,n,r){if(!e.subs)return[];let o=t===z.X?e.rangeOffsetsX:t===z.Y?e.rangeOffsetsY:e.rangeOffsetsZ;n=null===n?null:Math.floor(n),r=null===r?null:Math.floor(r);let i=[],a=0;for(let t=0;t<e.subs.length;t+=1){var l;let s=null==o?void 0:null===(l=o[t])||void 0===l?void 0:l[0];if(et(s))break;(null===n||n<s)&&(null===r||r>=a)&&i.push(e.subs[t]),a=s}return i}(e,d,null,a)))t.highlight=.5;else(function(e,t,n){let{dx:r}=tt(t,n),o=Math.ceil(r/e.cell),i=[],a=[];for(let r=0;r<o;r+=1){let o=to(e,t,n,r,r+1,0);i.push(o.subBlock),a.push(o.rangeOffset)}n===z.X&&(t.rangeOffsetsX=a),n===z.Y&&(t.rangeOffsetsY=a),n===z.Z&&(t.rangeOffsetsZ=a),t.subs=i})(r,t,z.X),e&&(e.highlight=1.5)}else console.log("srcIdx",c),i(n.src,c)}(l,n,a)}if(o.add)for(let e of o.add)i(e.src,new K(n.x,n.y)),i(e.src,new K(n.x,n.x))}}(e,n,l),function(e,t,n,r){if(!t.deps&&!t.meinsumResult)return;let o=e.render.sharedRender.activePhase;e.render.sharedRender.activePhase=R.Overlay2D,r=null!=r?r:n;let i=new K(eq(e.layout,t,z.X,r.x)+.5*e.layout.cell,eq(e.layout,t,z.Y,r.y)+.5*e.layout.cell,eq(e.layout,t,z.Z,r.z)+1.1*e.layout.cell),a=new eT,l={state:e,center:tw(e,i).round_().add(new K(0,-50)),blk:t,destIdx:n,mtx:a},s=new $;if(t.highlight=10,t.meinsumResult){(function(e){let{center:t,mtx:n}=e,r="\n    let fontOpts: IFontOpts = { color: opColor, mtx, size: 16 };\n    ";th({opts:{color:tT,mtx:n,size:16},subs:[{text:r},{text:r},{text:r}]})})(l);return}if(t.deps.lowerTri&&n.x>n.y?function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{text:"-"}]}))}(l):t.deps.special===D.InputEmbed?s=function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tR,mtx:n,size:16},subs:[{type:P.Custom,draw:t=>(function(e,t){let{state:n,center:r,destIdx:o,mtx:i}=e,a=tB(n.layout.idxObj,new K(o.x,0,o.z)),l=en(a)?a/(n.layout.tokEmbedObj.cx-1):.3,s=o.y/(n.layout.residual0.cy-1);r.add(new K(-35,-20,0));let c=eG.Weights,u=t.add(new K(40,30));tb(n.render,t,u,eW({color:c,mtx:i,n:new K(0,0,1),thick:.4})),tf(n.render.triRender,t,u,tz,i);let d=new K(t.x+ei(0,u.x-t.x-8,l),t.y),f=new K(d.x+8,u.y),h=new K(d.x,d.y+ei(0,u.y-t.y-8,s)),m=new K(f.x,h.y+8);tf(n.render.triRender,d,f,c.mul(.3),i),tf(n.render.triRender,h,m,c,i);let p=eG.Intermediates,x=d.x+4,g=d.y-5,v=u.x,y=new Float32Array([v,g-10,0,x,g-10,0,x,g,0]),_=eW({color:p,mtx:i,n:new K(0,0,1),thick:.5});e3(n.render.lineRender,y,_),ty(n.render,new K(1,1),new K(v+8,g-10),new K(7,7),eG.Intermediates,i)})(e,t.offset),size:new K(40,30)},{text:" + "},{type:P.Custom,draw:t=>(function(e,t){let{state:n,center:r,destIdx:o,mtx:i}=e,a=o.x/(n.layout.posEmbedObj.cx-1),l=o.y/(n.layout.residual0.cy-1);r.add(new K(35,-20,0));let s=eG.Weights,c=t.add(new K(40,30));tb(n.render,t,c,eW({color:s,mtx:i,n:new K(0,0,1),thick:.4})),tf(n.render.triRender,t,c,tz,i);let u=new K(t.x+ei(0,c.x-t.x-8,a),t.y),d=new K(u.x+8,c.y),f=new K(u.x,u.y+ei(0,c.y-t.y-8,l)),h=new K(d.x,f.y+8);tf(n.render.triRender,u,d,s.mul(.3),i),tf(n.render.triRender,f,h,s,i);let m={color:new Z(1,1,1,1).mul(.8),mtx:i,size:20},p=eI(n.render.modelFontBuf,"t",m);eP(n.render.modelFontBuf,"t",(f.x+h.x)/2-p/2,u.y-3-m.size,m)})(e,t.offset),size:new K(35,30)}]}),[20,0,0,0])}(l):t.deps.special===D.LayerNorm?s=function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{type:P.Divide,subs:[{subs:[{cellX:1,cellY:1,color:tE},{text:"  "},{type:P.Line,rectOpts:{color:eG.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"E[",color:tE},{cellX:1,cellY:3,color:tE},{text:"]",color:tE}]}]},{type:P.Line,rectOpts:{color:eG.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{type:P.Sqrt,subs:[{type:P.Line,subs:[{text:"Var[",color:tE},{cellX:1,cellY:3,color:tE},{text:"]",color:tE},{text:" + "}]}]}]}]},{text:"   "},{text:"",color:tA},{text:" + "},{text:"",color:tA}]}))}(l):t.deps.special===D.LayerNormMu?s=function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{text:"E[",color:tE},{cellX:1,cellY:3,color:tE},{text:"]",color:tE}]}))}(l):t.deps.special===D.LayerNormSigma?s=function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{type:P.Sqrt,subs:[{type:P.Line,subs:[{text:"Var[",color:tE},{cellX:1,cellY:3,color:tE},{text:"]",color:tE},{text:" + "}]}]}]}))}(l):t.deps.special===D.SoftmaxAggMax?s=function(e){let{center:t,mtx:n}=e;return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{text:"max("},{cellX:3,cellY:1,color:tE},{text:")"}]}))}(l):t.deps.special===D.SoftmaxAggExp?s=function(e){let{center:t,mtx:n}=e,r={color:tT,mtx:n,size:16};return tD(e,t,th({opts:r,subs:[{text:"",opts:{...r,size:1.5*r.size}},{text:"exp("},{cellX:1,cellY:1,color:tE},{text:" - "},{type:P.Line,rectOpts:{color:eG.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"max("},{cellX:3,cellY:1,color:tE},{text:")"}]},{text:")"}]}))}(l):t.deps.special===D.Softmax?s=function(e){let{center:t,mtx:n}=e,r={color:tT,mtx:n,size:16};return tD(e,t,th({opts:r,subs:[{type:P.Divide,subs:[{subs:[{text:"exp("},{cellX:1,cellY:1,color:tE},{text:" - "},{rectOpts:{color:eG.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"max("},{cellX:3,cellY:1,color:tE},{text:")"}]},{text:")"}]},{type:P.Line,rectOpts:{color:eG.Aggregates.mul(.8),mtx:n,thick:1,dash:6},subs:[{text:"",opts:{...r,size:1.5*r.size}},{text:"exp("},{cellX:1,cellY:1,color:tE},{text:" - "},{type:P.Line,subs:[{text:"max("},{cellX:3,cellY:1,color:tE},{text:")"}]},{text:")"}]}]}]}))}(l):t.deps.special===D.Attention?s=function(e){let{center:t,mtx:n,blk:r}=e,o=r.deps.dot[0],i=r.deps.dot[1];function a(e){let t=1===e.srcIdxMtx.g(0,3);return{cellX:t?4:1,cellY:t?1:4,color:"w"===e.src.t?tA:tE}}return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[{text:"dot("},a(o),{text:","},a(i),{text:") / "},{type:P.Sqrt,subs:[{text:"A"}]}]}))}(l):t.deps.special===D.Gelu?s=function(e){let{state:t,center:n,mtx:r,blk:o,destIdx:i}=e,a=e=>.5*e*(1+Math.tanh(Math.sqrt(2/Math.PI)*(e+.044715*e*e*e))),l=n.sub(new K(35,50,0)),s=n.add(new K(35,0,0));tM(t.render,l,s,tz,r,4);let c=tI(l.x,s.x,-3,3),u=tI(s.y,l.y,-.9428571428571428,2.142857142857143+1.2),d=new Float32Array(90);for(let e=0;e<30;e++){let t=-3+6*e/29,n=a(t);d[3*e+0]=c(t),d[3*e+1]=u(n)}let f=eW({color:new Z(.5,.5,.5,1),mtx:r,thick:1.5});eH(t.render.lineRender,new K(l.x,u(0)),new K(s.x,u(0)),f),eH(t.render.lineRender,new K(c(0),l.y),new K(c(0),s.y),f);let h=eW({color:eG.Intermediates,mtx:r,thick:3.5});e3(t.render.lineRender,d,h);let m=tB(o.deps.add[0].src,i);if(en(m)){let e=a(m);!function(e,t,n,r,o,i){let a=new Float32Array(90);for(let e=0;e<30;e++){let r=e/30*Math.PI*2;a[3*e+0]=t.x+Math.cos(r)*n,a[3*e+1]=t.y+Math.sin(r)*n,a[3*e+2]=t.z}e3(e.lineRender,a,eW({color:o,n:new K(0,0,1),thick:1,closed:!0,mtx:i}))}(t.render,new K(c(m),u(e)),2,0,eG.Intermediates,r)}return new $(l,s)}(l):t.deps.dot?s=function(e){let{center:t,mtx:n,blk:r}=e,o=!!r.deps.add,i=r.deps.dot[0],a=r.deps.dot[1];function l(e){let t=1===e.srcIdxMtx.g(0,3);return{cellX:t?4:1,cellY:t?1:4,color:"w"===e.src.t?tA:tE}}return tD(e,t,th({opts:{color:tT,mtx:n,size:16},subs:[o?{cellX:1,cellY:1,color:tA}:null,o?{text:" + dot("}:{text:"dot("},l(i),{text:","},l(a),{text:")"}].filter(en)}))}(l):t.deps.add&&2===t.deps.add.length&&(s=function(e){let{center:t,mtx:n}=e,r={color:tT,mtx:n,size:16};return tD(e,t,th({opts:r,subs:[{cellX:1,cellY:1,opts:{...r,color:tE}},{text:" + "},{cellX:1,cellY:1,opts:{...r,color:tE}}]}))}(l)),!s.empty){let e=function(e,t){let{center:n,mtx:r,blk:o,destIdx:i}=e,a={color:tT,mtx:r,size:14};function l(e,t){if(e===B.None)return null;let n=i.getAt(t),r=eY(e);return{text:"".concat(function(e){switch(e){case B.B:return"b";case B.T:return"t";case B.A:return"a";case B.C:case B.C4:return"c";default:return B[e]}}(e),": ").concat(n),color:r}}let s=l(o.dimX,0),c=l(o.dimY,1),u=th({opts:a,subs:[s,s&&c&&{text:", "},c]});tx(e.state.render,u),u.offset=new K(e.center.x-u.size.x/2,t.min.y-1.2*a.size-4,0),tg(u);let d=u.offset.sub(new K(4,4)),f=u.offset.add(u.size).add(new K(8,8));return tM(e.state.render,d,f,tz,r,4),tv(e.state.render,u),new $(d,f)}(l,s),t=new $(s.min,s.max,e.min,e.max);(function(e,t){let{state:n,mtx:r,blk:o,destIdx:i}=e;if(o.deps){if(o.deps.add)for(let e of o.deps.add)a(e);if(o.deps.dot){let e=tS(o,i);for(let t of o.deps.dot)a(t,e)}l(o,i,new Z(0,0,0,1),!0)}function a(t,r){var a;let{srcIdx:s,otherDim:c,isDot:u}=tk(t,i);if(0===t.src.opacity)return;if(u){let{cx:e}=tt(t.src,c);s.setAt(c,(null!=r?r:e)/2)}if((null===(a=o.deps)||void 0===a?void 0:a.special)===D.InputEmbed&&t.src===e.state.layout.tokEmbedObj){let e=tB(n.layout.idxObj,new K(i.x,0,i.z));s.setAt(z.X,null!=e?e:0)}let d=t.src.t,f="w"===d?eG.Weights:"i"===d?eG.Intermediates:eG.Aggregates;l(t.src,s,f,!1)}function l(e,o,i,a){let l=new K(eq(n.layout,e,z.X,o.x)+.5*n.layout.cell,eq(n.layout,e,z.Y,o.y)+.5*n.layout.cell,eq(n.layout,e,z.Z,o.z)+1.1*n.layout.cell);eW({n:new K(0,0,1),color:i,mtx:r,thick:.5,dash:10});let s=tw(n,l),c=t.center(),u=s.sub(c).normalize(),d=[(t.min.x-c.x)/u.x,(t.max.x-c.x)/u.x,(t.min.y-c.y)/u.y,(t.max.y-c.y)/u.y],f=null;for(let e of d){let n=c.mulAdd(u,e);if(e>0&&n.x>t.min.x-1e-5&&n.y>t.min.y-1e-5&&n.x<t.max.x+1e-5&&n.y<t.max.y+1e-5){f=c.mulAdd(u,e+4);break}}if(f){if(a){let e=s;s=f,f=e}(function(e,t,n,r,o,i){let a=n.sub(t).normalize(),l=K.cross(a,new K(0,0,1)).normalize(),s=t.lerp(n,.5).add(l.mul(-2*t.dist(n))),c=t.dist(s),u=Math.atan2(n.y-s.y,n.x-s.x),d=Math.atan2(t.y-s.y,t.x-s.x);u<d&&(u+=2*Math.PI),u-d>Math.PI&&(u-=2*Math.PI);let f=eW({color:r,mtx:o,thick:1,dash:0}),h=new Float32Array(96);for(let e=0;e<32;e++){let t=ei(d,u,e/31),n=s.x+c*Math.cos(t),r=s.y+c*Math.sin(t);h[3*e+0]=n,h[3*e+1]=r}e3(e.render.lineRender,h,f);let m=new K(Math.sin(u),-Math.cos(u)),p=m.rotateAbout(new K(0,0,1),-(.25*Math.PI)),x=m.rotateAbout(new K(0,0,1),.25*Math.PI);eH(e.render.lineRender,n,n.mulAdd(p,10),f),eH(e.render.lineRender,n,n.mulAdd(x,10),f)})(n,s,f,i,r,0)}}})(l,t)}e.render.sharedRender.activePhase=o}(e,n,l)}else if(en(e.display.blkIdxHover))for(let t of e.display.blkIdxHover)tP(e.layout.cubes[t],e=>{e.highlight=.2});if(en(e.display.dimHover)){let t=e.walkthrough.dimHighlightBlocks;for(let n of null!=t?t:[])n.dimX===e.display.dimHover&&e6(e,e.layout,n,z.X,n.dimX,1),n.dimY===e.display.dimHover&&e6(e,e.layout,n,z.Y,n.dimY,1)}}(t),t.render.sharedRender.activePhase=R.Opaque,new Z(.4,.4,.4,1);let s=1,c=t.render.size.x;for(let e of(t.render.sharedRender.activePhase=R.Overlay2D,t.display.lines)){let n={color:new Z,size:14},r=eI(t.render.modelFontBuf,e,n);eP(t.render.modelFontBuf,e,c-r-4,s*n.size*1.3+4,n),s++}(function(e){let t,n,{layout:r,render:o,camera:i}=e,{gl:a,blockRender:l,size:s}=o,{modelMtx:c,viewMtx:u}=i,{camPos:d}=e4(i),f=[new K(100,400,600),new K(-200,-300,-300),new K(200,-100,0)],h=[new K(1,.2,.2),new K(1,.2,.2),new K(1,.2,.2)],m=new Float32Array(9),p=new Float32Array(9);for(let e=0;e<3;e++)c.mulVec3Proj(f[e]).writeToBuf(m,3*e),c.mulVec3Proj(h[e]).writeToBuf(p,3*e);if(a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(0,0,s.x,s.y),a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.DEPTH_TEST),a.enable(a.CULL_FACE),a.cullFace(a.FRONT),a.frontFace(a.CW),o.renderTiming){let e="GPU: ".concat(o.lastGpuMs.toFixed(1),"ms JS: ").concat(o.lastJsMs.toFixed(1),"ms"),t=s.x;o.sharedRender.activePhase=R.Overlay2D;let n=eF(o.modelFontBuf,e,14);ek(o.modelFontBuf,e,new Z(0,0,0,1),t-n-4,4,14,new eT)}eB(o.sharedRender,c,u);{let e,t,n,i,a,s=r.cubes.filter(e=>e.highlight>0);(function(e){let t=e.gl,n=t.canvas.width,r=t.canvas.height,o=Math.floor(n*e.blurFactor),i=Math.floor(r*e.blurFactor);if(e.currViewSize.x!==n||e.currViewSize.y!==r){for(let n of(t.bindTexture(t.TEXTURE_2D,e.initialTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,i,0,t.RGBA,t.UNSIGNED_BYTE,null),e.blurFbos))t.bindTexture(t.TEXTURE_2D,n.tex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,i,0,t.RGBA,t.UNSIGNED_BYTE,null);e.currViewSize=new K(n,r)}t.bindFramebuffer(t.FRAMEBUFFER,e.initialFbo),t.viewport(0,0,o,i),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)})(o.blurRender),function(e,t){let n=e.gl;if(!e.simpleShader.ready)return;let r=e.simpleShader.locs,o=e.cubeGeom;for(let i of(n.useProgram(e.simpleShader.program),n.bindVertexArray(o.vao),t)){n.uniform3f(r.u_size,i.dx,i.dy,i.dz),n.uniform3f(r.u_offset,i.x,i.y,i.z);let e=("w"===i.t?new Z(.3,.3,1,1):new Z(.4,.8,.4,1)).mul(i.highlight);n.uniform4f(r.u_baseColor,e.x,e.y,e.z,e.w),n.drawArrays(o.type,0,o.numVerts)}}(l,s),t=(e=(x=o.blurRender).gl).canvas.width,n=e.canvas.height,i=Math.floor(t*x.blurFactor),a=Math.floor(n*x.blurFactor),e.bindVertexArray(x.quadVao),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.STENCIL_TEST),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,x.initialTex),e.bindFramebuffer(e.FRAMEBUFFER,x.blurFbos[0].fbo),e.viewport(0,0,i,a),e.useProgram(x.horizShader.program),e.uniform1i(x.horizShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4),e.bindTexture(e.TEXTURE_2D,x.blurFbos[0].tex),e.bindFramebuffer(e.FRAMEBUFFER,x.blurFbos[1].fbo),e.viewport(0,0,i,a),e.useProgram(x.vertShader.program),e.uniform1i(x.vertShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4),e.enable(e.BLEND),e.viewport(0,0,t,n),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,x.blurFbos[1].tex),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,x.initialTex),e.useProgram(x.overlayShader.program),e.uniform1i(x.overlayShader.locs.u_texture,0),e.drawArrays(e.TRIANGLE_FAN,0,4)}for(let s of(a.enable(a.DEPTH_TEST),ef(t=(g=o.lineRender).gl,g.floatBuf),ex(t,g.indexBuf),ef(n=(v=o.triRender).gl,v.vbo),ex(n,v.ibo),function(e){let t=e.atlas.gl;if(t.bindTexture(t.TEXTURE_2D,e.transformTex),e.segmentCapacity>e.glSegmentCapacity){let n=Math.ceil(20*e.segmentCapacity/4/1024);t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,1024,n,0,t.RGBA,t.FLOAT,null),e.glSegmentCapacity=1024*n/4}{let n=Math.ceil(20*e.segmentsUsed/4/1024);t.texSubImage2D(t.TEXTURE_2D,0,0,0,1024,n,t.RGBA,t.FLOAT,e.localTexBuffer)}ef(t,e.vertBuffer)}(o.modelFontBuf),function(e,t,n,r,o,i){let a=e.gl,l=e.shader.locs,s=e.cubeGeom;if(!e.shader.ready)return;a.useProgram(e.shader.program);let c=n.mulVec3Proj(r);a.uniform3f(l.u_camPos,c.x,c.y,c.z),a.uniform1i(l.u_accessSampler,0),a.enable(a.BLEND),a.enable(a.CULL_FACE),a.activeTexture(a.TEXTURE0),a.bindVertexArray(s.vao);let u=[],d=[];t.cubes.forEach(function e(t){t.subs?t.subs.forEach(e):t.opacity<.8&&t.opacity>0?d.push(t):t.opacity>0&&u.push(t)});let f=[...u,...d],h=u.length,m=e.blockUbo.localBufs[0],p=e.blockAccessUbo.localBufs[0];{eh(e.blockUbo),ed(m,u.length);let t=m.buf;for(let e of f){var x;let n=m.usedEls*m.strideFloats;t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+4]=e.dx,t[n+5]=e.dy,t[n+6]=e.dz,t[n+8]=e.cx,t[n+9]=e.cy,t[n+10]=e.cz,t.set(null!==(x=e.localMtx)&&void 0!==x?x:new eT,n+12);let r="w"===e.t?eG.Weights:"i"===e.t?eG.Intermediates:eG.Aggregates;new Z(r.x,r.y,r.z,e.opacity).writeToBuf(t,n+28),t[n+32]=e.highlight,m.usedEls+=1}ef(a,e.blockUbo)}{eh(e.blockAccessUbo),ed(p,u.length);let t=p.buf;for(let e of f){let n=p.usedEls*p.strideFloats;if(e.access&&!0!==e.access.disable){t.set(e.access.mat.slice(0,8),n);let r=e.access.channel;t[n+8]="r"===r?0:"g"===r?1:"b"===r?2:3,t[n+9]=e.access.scale}else t[n+9]=0;p.usedEls+=1}ef(a,e.blockAccessUbo)}let g=!0,v=0;for(let t of f){v===h&&a.depthMask(!1),a.bindBufferRange(a.UNIFORM_BUFFER,eR.Block,e.blockUbo.buf,v*m.strideBytes,m.strideBytes);let n=!!t.access&&!0!==t.access.disable;(g||n)&&(a.bindBufferRange(a.UNIFORM_BUFFER,eR.BlockAccess,e.blockAccessUbo.buf,v*p.strideBytes,p.strideBytes),a.bindTexture(a.TEXTURE_2D,n&&t.access?t.access.src.texture:e.dummyTexture),g=n),a.drawArrays(s.type,0,s.numVerts),v++}a.depthMask(!0)}(l,r,c,d,0,0),o.sharedRender.activePhase=R.Opaque,e.examples))if(s.enabled&&s.layout){let{modelMtx:e,viewMtx:t}=i,{camPos:n}=e4(i);var x,g,v,y=e.mul(eT.fromTranslation(s.offset));eB(o.sharedRender,y,t),function(e,t,n,r){if(!e.instancedShader.ready)return;let o=e.gl,i=e.instancedShader.locs,a=e.blockAccessUbo.localBufs[0];o.useProgram(e.instancedShader.program);let l=n.invert().mulVec3Proj(r);if(o.uniform3f(i.u_camPos,l.x,l.y,l.z),o.uniform1i(i.u_accessSampler,0),o.enable(o.BLEND),o.enable(o.CULL_FACE),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,e.dummyTexture),o.bindVertexArray(e.instancedVao),e.instancedDataStale){e.instancedDataStale=!1;{eh(e.instancedFloatBuf);let n=e.instancedFloatBuf.localBufs[0];ed(n,t.cubes.length);let r=n.buf;for(let e of t.cubes){var s;if(e.small)continue;let t=n.usedEls*n.strideFloats;r[t+0]=e.x,r[t+1]=e.y,r[t+2]=e.z,r[t+4]=e.dx,r[t+5]=e.dy,r[t+6]=e.dz,r[t+8]=e.cx,r[t+9]=e.cy,r[t+10]=e.cz,r.set(null!==(s=e.localMtx)&&void 0!==s?s:new eT,t+12);let o="w"===e.t?eG.Weights:"i"===e.t?eG.Intermediates:eG.Aggregates;new Z(o.x,o.y,o.z,e.opacity).writeToBuf(r,t+28),r[t+32]=e.highlight,n.usedEls+=1}ef(o,e.instancedFloatBuf),e.instancedNumBlocks=n.usedEls}eh(e.blockAccessUbo),ed(a,1),a.buf[9]=0,a.usedEls+=1,ef(o,e.blockAccessUbo)}o.bindBufferRange(o.UNIFORM_BUFFER,eR.BlockAccess,e.blockAccessUbo.buf,0,a.strideBytes),o.drawArraysInstanced(e.cubeGeom.type,0,e.cubeGeom.numVerts,e.instancedNumBlocks),o.depthMask(!0)}(s.blockRender,s.layout,y,n)}for(let e of(eB(o.sharedRender,c,u),function(e){let{gl:t,shader:n,vao:r}=e;t.enable(t.POLYGON_OFFSET_FILL),t.disable(t.CULL_FACE),t.depthMask(!1),t.polygonOffset(-1,-2);let o=n.locs;for(let i of(t.useProgram(n.program),t.bindVertexArray(r),e.threadInfos)){let e=i.baseColor;t.uniform3f(o.u_offset,i.pos.x,i.pos.y,i.pos.z),t.uniform3f(o.u_size,i.size.x,i.size.y,i.size.z),t.uniform2f(o.u_nCells,i.nCells.x,i.nCells.y),t.uniform3f(o.u_baseColor,e.x,e.y,e.z),t.uniformMatrix3x2fv(o.u_threadDir,!1,i.threadDir),t.drawArrays(t.TRIANGLE_FAN,0,4)}e.threadInfos=[],t.disable(t.POLYGON_OFFSET_FILL),t.depthMask(!0)}(o.threadRender),a.polygonOffset(-1,-2),[R.Opaque,R.Arrows,R.Overlay,R.Overlay2D])){if(e===R.Overlay2D){let e=s.x,t=s.y;a.clear(a.DEPTH_BUFFER_BIT),eB(o.sharedRender,new eT,eT.fromOrtho(0,e,t,0,-1,1))}e===R.Overlay||e===R.Overlay2D?a.enable(a.POLYGON_OFFSET_FILL):a.disable(a.POLYGON_OFFSET_FILL),function(e,t){let n=e.gl,r=e.ibo.localBufs[t];0!==r.usedVerts&&(n.depthMask(t===R.Opaque),n.disable(n.CULL_FACE),n.useProgram(e.triShader.program),n.bindVertexArray(e.vao),n.drawElements(n.TRIANGLE_STRIP,r.usedVerts,n.UNSIGNED_INT,r.glOffsetBytes),n.depthMask(!0))}(o.triRender,e),function(e,t){let n=e.atlas,r=n.gl;r.disable(r.CULL_FACE),r.depthMask(!1),r.useProgram(n.program.program);let o=n.program.locs;r.uniform1f(o.pxRange,4),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,n.atlasTex),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,e.transformTex),r.bindVertexArray(e.vao);let i=e.vertBuffer.localBufs[t];r.drawArrays(r.TRIANGLES,i.glOffsetEls,i.usedEls),r.depthMask(!0)}(o.modelFontBuf,e),function(e,t){let n=e.gl,r=e.indexBuf.localBufs[t];if(0===r.usedVerts)return;n.disable(n.CULL_FACE),n.depthMask(!1),n.useProgram(e.lineShader.program),n.bindVertexArray(e.vao);let o=e.lineShader.locs;n.uniform2f(o.u_viewSizeInv,1/n.canvas.width,1/n.canvas.height),n.drawElements(n.TRIANGLE_STRIP,r.usedVerts,n.UNSIGNED_INT,r.glOffsetBytes),n.depthMask(!0)}(o.lineRender,e)}a.disable(a.POLYGON_OFFSET_FILL)})(t),function(e,t){if(!e.ctx.ext.disjointTimerQuery)return;let n=e.queries.get(t);n&&n.hasRun&&n.hasStarted&&(e.ctx.gl.endQuery(e.TIME_ELAPSED_EXT),n.hasStarted=!1)}(t.render.queryManager,"render"),t.render.gl.flush(),t.render.lastJsMs=performance.now()-a}({time:e,dt:t,markDirty:this.markDirty},this.progState),this.progState.htmlSubs.notify()}constructor(e,t,n){this.canvasData=t,this.modelState=null,this.stopped=!1,this.canvasSizeDirty=!0,this.prevTime=performance.now(),this.rafHandle=0,this.isDirty=!1,this.isWaitingForSync=!1,this.markDirty=()=>{this.canvasData&&!this.stopped&&(this.isDirty=!0,this.rafHandle||(this.prevTime=performance.now(),this.rafHandle=requestAnimationFrame(this.loop)))},this.loop=e=>{var t,n,r,o;if(!(this.isDirty||this.isWaitingForSync)||this.stopped){this.rafHandle=0;return}let i=this.isDirty;this.isDirty=!1,this.isWaitingForSync=!1;let a=e-this.prevTime;this.prevTime=e,a<8&&(a=16),this.checkSyncObjects();let l=null!==(r=null===(t=this.progState.render)||void 0===t?void 0:t.syncObjects.length)&&void 0!==r?r:0;(i||this.isDirty)&&this.render(e,a),(null!==(o=null===(n=this.progState.render)||void 0===n?void 0:n.syncObjects.length)&&void 0!==o?o:0)!==l&&(this.isWaitingForSync=!0),this.rafHandle=requestAnimationFrame(this.loop)},this.progState=function(e,t){var n,r,o,i,a,l,s,c,u;let d=function(e,t){var n;let r,o,i,a,l,s,c,u,d,f,h,m,p,x,g,v,y,_,b,w,A,E,T,B=e.getContext("webgl2",{antialias:!0});if(!B)return null;let M={colorBufferFloat:B.getExtension("EXT_color_buffer_float"),disjointTimerQuery:B.getExtension("EXT_disjoint_timer_query_webgl2")};M.colorBufferFloat||console.log("initRender: EXT_color_buffer_float not supported: floating point textures will not work."),M.disjointTimerQuery||console.log("initRender: EXT_disjoint_timer_query_webgl2 not supported: GPU timing will not work.");let D={gl:B,vertShaders:new Map,fragShaders:new Map,programs:[],unlinkedPrograms:[]},F={gl:B,shaderManager:D,ext:M},I=B.createBuffer();B.bindBuffer(B.ARRAY_BUFFER,I),B.bufferData(B.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),B.STATIC_DRAW);let P=B.createVertexArray();B.bindVertexArray(P),B.enableVertexAttribArray(0),B.vertexAttribPointer(0,2,B.FLOAT,!1,0,0);let k=(o=(r=F.gl).createBuffer(),r.bindBuffer(r.UNIFORM_BUFFER,o),r.bufferData(r.UNIFORM_BUFFER,128,r.DYNAMIC_DRAW),r.bindBufferBase(r.UNIFORM_BUFFER,eR.ModelView,o),{gl:r,modelViewUbo:o,modelViewBuf:new Float32Array(32),activePhase:R.Opaque,numPhases:4}),S=function(e,t){let n=e.gl,r=t.fontDef,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t.fontAtlasImage);let i=el(e.shaderManager,"font","#version 300 es\n        precision highp float;\n        ".concat(eM,"\n        uniform sampler2D u_transformTex;\n        layout (location = 0) in vec2 a_position;\n        layout (location = 1) in vec2 a_uv;\n        layout (location = 2) in float a_textId;\n        out vec2 v_uv;\n        out vec4 v_fgColor;\n        out vec4 v_bgColor;\n\n        void main() {\n            int texWidth = textureSize(u_transformTex, 0).x;\n            int texOffset = int(a_textId) * ").concat(5,";\n            int y = texOffset / texWidth;\n            int x = texOffset % texWidth;\n            vec4 t0 = texelFetch(u_transformTex, ivec2(x + 0, y), 0);\n            vec4 t1 = texelFetch(u_transformTex, ivec2(x + 1, y), 0);\n            vec4 t2 = texelFetch(u_transformTex, ivec2(x + 2, y), 0);\n            vec4 t3 = texelFetch(u_transformTex, ivec2(x + 3, y), 0);\n            vec4 c = texelFetch(u_transformTex, ivec2(x + 4, y), 0);\n            mat4 transform = mat4(t0, t1, t2, t3);\n\n            gl_Position = u_view * u_model * transform * vec4(a_position, 0.0, 1.0);\n            v_uv = a_uv;\n            v_fgColor = c;\n            v_bgColor = vec4(0, 0, 0, 0);\n        }\n\n    "),"#version 300 es\n        precision highp float;\n        uniform sampler2D u_tex;\n        uniform float pxRange; // set to distance field's pixel range\n        in vec2 v_uv;\n        in vec4 v_fgColor;\n        in vec4 v_bgColor;\n        out vec4 color;\n\n        float median(float r, float g, float b) {\n            return max(min(r, g), min(max(r, g), b));\n        }\n\n        float screenPxRange() {\n            vec2 unitRange = vec2(pxRange) / vec2(textureSize(u_tex, 0));\n            vec2 screenTexSize = vec2(1.0) / fwidth(v_uv);\n            return max(0.5*dot(unitRange, screenTexSize), 1.0);\n        }\n\n        void main() {\n            vec3 msd = texture(u_tex, v_uv).rgb;\n            float sd = median(msd.r, msd.g, msd.b);\n            float screenRange = screenPxRange();\n            float screenPxDistance = screenRange*(sd - 0.5);\n            float opacity = clamp(screenPxDistance + 0.5, 0.0, 1.0);\n\n            float blurOpacity = 0.0; //smoothstep(0.5 - 0.4, 0.5, sd);\n\n            if (opacity == 0.0 && blurOpacity == 0.0) {\n                discard;\n            }\n            color = mix(vec4(0,0,0,1.0) * blurOpacity, v_fgColor, opacity);\n        }\n    ",["u_tex","u_transformTex","pxRange"],{uboBindings:{ModelViewUbo:eR.ModelView}});es(e.shaderManager);let a=i.locs;n.useProgram(i.program),n.uniform1i(a.u_tex,0),n.uniform1i(a.u_transformTex,1);let l=[];for(let e of r.faces){let t=new Int16Array(eo(e.chars)),n=t.length/12,r=new Map,o=new Map,i=[];for(let e=0;e<n;e++){let n=12*e,a={id:t[n+0],index:t[n+1],char:String.fromCharCode(t[n+2]),x:t[n+3],y:t[n+4],width:t[n+5],height:t[n+6],xoffset:t[n+7],yoffset:t[n+8],xadvance:t[n+9],page:t[n+10],chnl:t[n+11]};r.set(a.char,a),o.set(a.id,a),i.push(a)}let a=new Int16Array(eo(e.kernings)),s=a.length/3,c=new Map;for(let e=0;e<s;e++){let t=3*e,n={first:a[t+0],second:a[t+1],amount:a[t+2]},r=o.get(n.first).char,i=o.get(n.second).char;c.set("".concat(r).concat(i),n.amount)}l.push({name:e.name,common:e.common,charMap:r,kernMap:c})}return{gl:n,faceInfos:l,program:i,atlasTex:o}}(F,t),C=(a=(i=S.gl).createTexture(),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA32F,1024,Math.ceil(5),0,i.RGBA,i.FLOAT,null),l=i.createVertexArray(),i.bindVertexArray(l),s=i.createBuffer(),ec(i,s,{},[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_texIndex",size:1}]),{atlas:S,vao:l,transformTex:a,vertBuffer:eu(i,i.ARRAY_BUFFER,s,1024,20,k),localTexBuffer:new Float32Array(20480),segmentsUsed:0,segmentCapacity:1024,glSegmentCapacity:1024,sharedRender:k}),L=(u=(c=F.gl).createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,u),c.bufferData(c.ARRAY_BUFFER,new Float32Array([0,1,0,1,1,0,1,0,0,0,0,0]),c.STATIC_DRAW),d=c.createVertexArray(),c.bindVertexArray(d),c.enableVertexAttribArray(0),c.vertexAttribPointer(0,3,c.FLOAT,!1,0,0),f=c.createBuffer(),h=ec(c,f,{divisor:1,locOffset:2},[{name:"a_offset",size:3},{name:"a_size",size:3},{name:"a_nCells",size:2},{name:"a_threadDir",size:2,nCols:3}]),{gl:c,vao:d,quadVbo:u,instanceVbo:f,instanceBuf:eu(c,c.ARRAY_BUFFER,f,1024,h,null),numInstances:0,shader:el(F,"thread","#version 300 es\n        precision highp float;\n        ".concat(eM,"\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n\n        uniform vec3 u_offset;\n        uniform vec3 u_size;\n        uniform vec2 u_nCells;\n        uniform mat3x2 u_threadDir;\n        out vec3 v_normal;\n        out vec3 v_modelPos;\n        out vec2 v_blockPos;\n        out vec2 v_squarePos;\n        void main() {\n            vec2 localPos = u_threadDir * vec3(a_position.xy, 1);\n            vec3 model_pos = a_position * u_size + u_offset;\n            gl_Position = u_view * u_model * vec4(model_pos, 1);\n            v_normal = a_normal;\n            v_modelPos = model_pos;\n            v_blockPos = localPos * abs(u_threadDir * vec3(u_nCells, 0));\n            v_squarePos = localPos;\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec3 v_normal;\n        in vec3 v_modelPos;\n        in vec2 v_blockPos;\n        in vec2 v_squarePos;\n        out vec4 o_color;\n        uniform vec2 u_nCells;\n        uniform vec3 u_camPos; // in model space\n        uniform vec3 u_baseColor;\n\n        void main() {\n            ivec2 blockPos = ivec2(v_blockPos - v_normal.xy * 0.0);\n\n            vec2 pxPerCell = 1.0 / fwidth(v_blockPos);\n            float maxPxPerCell = max(pxPerCell.x, pxPerCell.y);\n\n            vec4 color = vec4(0);\n\n            if (v_blockPos.y < 0.0) {\n                discard;\n            }\n\n            if (blockPos.y == 0) {\n                // draw head\n                vec2 d = fract(v_blockPos) - 0.5;\n                float d2 = sqrt(d.x * d.x + d.y * d.y);\n\n                // fwidth(d);\n                float deltad2_per_px = fwidth(d2); // fwidth(d2);\n\n                float t = 1.0 - smoothstep(0.45, 0.45 + 1.0 * deltad2_per_px, d2);\n\n                float t2 = smoothstep(0.35, 0.35 + 1.0 * deltad2_per_px, d2);\n\n                // if (d2 > 0.35 && d2 < 0.45) {\n                color = mix(color, vec4(u_baseColor, 1), min(t, t2));\n                // }\n            }\n\n            if (v_blockPos.y > (0.5 + 0.45)) {\n                float falloffY = 1.0 - clamp(v_blockPos.y / 10.0, 0.0, 1.0);\n\n                float cellPosX = fract(v_blockPos.x);\n                float distFromX = abs(cellPosX - 0.5);\n                // small side-to-side falloff based on distFromX for a glow effect\n                float falloffX = 1.0 - smoothstep(0.0, min(0.3, 5.0 * fwidth(v_blockPos.x)), distFromX);\n\n                color = mix(color, vec4(u_baseColor, 1), falloffX * falloffY);\n            }\n\n            // color = vec4(1, 0, 0, 1);\n\n            o_color = color;\n        }\n    ",["u_size","u_offset","u_baseColor","u_nCells","u_threadDir"],{uboBindings:{ModelViewUbo:eR.ModelView}}),threadInfos:[]}),U=(p=(m=F.gl).createVertexArray(),m.bindVertexArray(p),x=m.createBuffer(),g=ec(m,x,{},[{name:"a_position",size:3},{name:"a_lineDirA",size:3},{name:"a_lineDirB",size:3},{name:"a_color",size:4},{name:"a_thickness",size:1},{name:"a_firstPair",size:1},{name:"a_normal",size:3},{name:"a_dash",size:1},{name:"a_t",size:1}]),v=eu(m,m.ARRAY_BUFFER,x,1024,g,null),y=m.createBuffer(),{gl:m,vao:p,floatBuf:v,indexBuf:em(m,y,1024,k),lineShader:el(F,"line","#version 300 es\n        precision highp float;\n        ".concat(eM,"\n        uniform vec2 u_viewSizeInv;\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_lineDirA;\n        layout(location = 2) in vec3 a_lineDirB;\n        layout(location = 3) in vec4 a_color;\n        layout(location = 4) in float a_thickness;\n        layout(location = 5) in float a_firstPair;\n        layout(location = 6) in vec3 a_normal;\n        layout(location = 7) in float a_dash;\n        layout(location = 8) in float a_t;\n        out vec2 v_linePos;\n        out vec4 v_color;\n        out float v_thickness;\n        out float v_dash;\n        void main() {\n\n            float mul = 1.0;\n            if (gl_VertexID % 2 == 0) {\n                mul = -1.0;\n            }\n\n            bool firstPair = a_firstPair > 0.0;\n\n            float width;\n\n            if (length(a_normal) == 0.0) {\n                vec4 clipPos = u_view * u_model * vec4(a_position, 1);\n                vec2 screenPos = clipPos.xy / clipPos.w;\n\n                vec4 lineDirAClip = u_view * u_model * vec4(a_position + a_lineDirA, 1);\n                vec2 lineDirA = normalize(lineDirAClip.xy / lineDirAClip.w - screenPos);\n                vec4 lineDirBClip = u_view * u_model * vec4(a_position + a_lineDirB, 1);\n                vec2 lineDirB = normalize(lineDirBClip.xy / lineDirBClip.w - screenPos);\n\n                vec2 avgDir = normalize(lineDirA + lineDirB);\n                vec2 activeDir = firstPair ? lineDirA : lineDirB;\n\n                float scale = sqrt(2.0) / length(lineDirA + lineDirB);\n                vec2 offset = vec2(-avgDir.y, avgDir.x);\n\n                if (scale > 5.0) {\n                    bool isOuter = cross(vec3(lineDirA, 0), vec3(lineDirB, 0)).z * mul < 0.0;\n                    if (isOuter) {\n                        offset = vec2(-activeDir.y, activeDir.x);\n                        scale = 1.0 / sqrt(2.0);\n                    } else {\n                        offset = vec2(-activeDir.y, activeDir.x);\n                        scale = 1.0 / sqrt(2.0);\n                    }\n                }\n\n                width = a_thickness * 2.0;\n                vec2 linePos = screenPos + offset * u_viewSizeInv * width * mul * scale;\n\n                gl_Position = vec4(linePos.xy * clipPos.w, clipPos.z, clipPos.w);\n                v_thickness = a_thickness;\n\n            } else {\n\n                width = a_thickness * 2.0;\n                vec3 activeDir = firstPair ? a_lineDirA : a_lineDirB;\n\n                vec3 avgDir = normalize(a_lineDirA + a_lineDirB);\n                vec3 offset = normalize(cross(a_normal, avgDir));\n                // need to scale by the amount of angle between the two line directions\n                float scale = sqrt(2.0) / length(a_lineDirA + a_lineDirB);\n\n                // if we exceed the miter limit (90 degrees), we need to clamp the line width, and draw a bevel instead.\n                // the inner corner stays the same, but the outer corner is a bevel.\n\n                if (scale > 2.0) {\n                    bool isOuter = cross(a_lineDirA, a_lineDirB).z * mul < 0.0;\n\n                    if (isOuter) {\n                        offset = normalize(cross(a_normal, activeDir));\n                        scale = 1.0 / sqrt(2.0);\n                    }\n                }\n\n                vec3 linePos = a_position + offset * mul * width * scale;\n\n                gl_Position = u_view * u_model * vec4(linePos, 1);\n                v_thickness = 100.0;\n\n            }\n\n            v_dash = a_dash;\n            v_color = a_color;\n            v_linePos = vec2(mul * width, a_t);\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec2 v_linePos;\n        in vec4 v_color;\n        in float v_thickness;\n        in float v_dash;\n        out vec4 o_color;\n\n        void main() {\n            float lineWidth = v_thickness - 1.0;\n            float edge0 = lineWidth / 2.0;\n            float edge1 = lineWidth / 2.0 + fwidth(v_linePos.x);\n            float t = 1.0 - smoothstep(edge0, edge1, abs(v_linePos.x));\n\n            if (v_dash > 0.0) {\n                float dashPos = mod(v_linePos.y, v_dash);\n                if (dashPos > v_dash / 2.0) {\n                    t = 0.0;\n                }\n            }\n\n            if (t == 0.0) {\n                discard;\n            }\n\n            o_color = v_color * t;\n        }\n    ",["u_viewSizeInv"],{uboBindings:{ModelViewUbo:eR.ModelView}}),sharedRender:k}),O=tN(F),N=(b=(_=F.gl).createVertexArray(),_.bindVertexArray(b),w=_.createBuffer(),A=ec(_,w,{},[{name:"a_pos",size:3},{name:"a_normal",size:3},{name:"a_color",size:4},{name:"a_uv",size:2}]),E=eu(_,_.ARRAY_BUFFER,w,1024,A,null),T=_.createBuffer(),{gl:_,vao:b,vbo:E,ibo:em(_,T,1024,k),triShader:el(F,"triangles","#version 300 es\n        precision highp float;\n        ".concat(eM,"\n        layout(location = 0) in vec3 a_position;\n        layout(location = 1) in vec3 a_normal;\n        layout(location = 2) in vec4 a_color;\n        layout(location = 3) in vec2 a_uv;\n        out vec4 v_color;\n        out vec2 v_uv;\n        out vec3 v_normal;\n        void main() {\n            gl_Position = u_view * u_model * vec4(a_position, 1);\n            v_color = a_color;\n            v_normal = a_normal;\n            v_uv = a_uv;\n        }\n    "),"#version 300 es\n        precision highp float;\n        in vec2 v_uv;\n        in vec3 v_normal;\n        in vec4 v_color;\n        out vec4 o_color;\n\n        void main() {\n            o_color = v_color;\n        }\n    ",[],{uboBindings:{ModelViewUbo:eR.ModelView}}),sharedRender:k}),X=function(e,t){let n=e.gl,r=Math.max(n.canvas.width,1),o=Math.max(n.canvas.height,1),i=n.createFramebuffer(),a=n.createTexture();function l(){let e=n.createFramebuffer(),t=n.createTexture();n.bindFramebuffer(n.FRAMEBUFFER,e),n.bindTexture(n.TEXTURE_2D,t),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,r,o,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0);{let e=n.checkFramebufferStatus(n.FRAMEBUFFER);e!==n.FRAMEBUFFER_COMPLETE&&console.log("Blur framebuffer not complete: ".concat(e.toString(16)))}return{fbo:e,tex:t}}n.bindFramebuffer(n.FRAMEBUFFER,i),n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,r,o,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,a,0);let s=[l(),l()],c=new Float32Array(36),u=0;for(let e=-4;e<=4;e++){let t=e/2,n=Math.exp(-t*t*.5);c[4*(e+4)]=n,u+=n}for(let e=0;e<9;e++)c[4*e]/=u;let d=n.createBuffer();function f(t,n){return el(e.shaderManager,t,"#version 300 es\n            precision highp float;\n            layout(location = 0) in vec2 a_position;\n            void main() {\n                gl_Position = vec4(a_position, 0, 1);\n            }\n        ","#version 300 es\n            precision highp float;\n\n            layout(std140) uniform BlurWeights {\n                float weights[".concat(9,"];\n            };\n\n            uniform sampler2D u_texture;\n            out vec4 o_color;\n\n            void main() {\n                ivec2 pos = ivec2(gl_FragCoord.xy);\n                vec4 color = vec4(0);\n                vec4 center = texelFetch(u_texture, pos, 0);\n                for (int i = -").concat(4,"; i <= ").concat(4,"; i++) {\n                    int wId = i + ").concat(4,";\n                    color += texelFetch(u_texture, pos + ivec2(").concat(n===z.X?"i, 0":"0, i",") * ").concat(2,", 0) * weights[wId];\n                }\n                o_color = max(color, center);\n            }\n        "),["u_texture"],{uboBindings:{BlurWeights:eR.blur}})}return n.bindBuffer(n.UNIFORM_BUFFER,d),n.bufferData(n.UNIFORM_BUFFER,c.buffer,n.STATIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,eR.blur,d),{gl:n,quadVao:t,initialFbo:i,initialTex:a,blurFbos:s,horizShader:f("blurHoriz",z.X),vertShader:f("blurVert",z.Y),overlayShader:el(e.shaderManager,"blurOverlay","#version 300 es\n            precision highp float;\n            layout(location = 0) in vec2 a_position;\n            out vec2 v_uv;\n            void main() {\n                gl_Position = vec4(a_position, 0, 1);\n                v_uv = a_position * 0.5 + 0.5;\n            }\n        ","#version 300 es\n            precision highp float;\n            uniform sampler2D u_texture;\n            uniform sampler2D u_initTexture;\n            in vec2 v_uv;\n            out vec4 o_color;\n\n            void main() {\n                ivec2 pos = ivec2(gl_FragCoord.xy);\n                vec4 blurColor = texture(u_texture, v_uv);\n                // vec4 initColor = texture(u_initTexture, v_uv);\n\n                vec4 base = vec4(0.9, 0.9, 0.9, 0.1);\n                // if (blurColor.a == 0.0) {\n                //     blurColor = vec4(0.1, 0.1, 0.1, 1.0);\n                // }\n                o_color = blurColor; // + initColor * (1.0 - blurColor.a);\n                // o_color = initColor;\n            }\n        ",["u_texture"]),currViewSize:new K(0,0),blurFactor:.3}}(F,P),j={ctx:F,queries:new Map,TIME_ELAPSED_EXT:null===(n=F.ext.disjointTimerQuery)||void 0===n?void 0:n.TIME_ELAPSED_EXT};return es(D),{canvasEl:e,gl:B,ctx:F,blockRender:O,threadRender:L,lineRender:U,blurRender:X,triRender:N,sharedRender:k,fontAtlas:S,modelFontBuf:C,quadVao:P,queryManager:j,syncObjects:[],size:new K(1,1),lastGpuMs:0,lastJsMs:0,renderTiming:!1}}(e,t),f={phase:null!==(c=null===(l=ti.state)||void 0===l?void 0:l.phase)&&void 0!==c?c:S.Intro_Intro,time:null!==(u=null===(s=ti.state)||void 0===s?void 0:s.phaseTime)&&void 0!==u?u:0,viewDt:0,dt:0,prevTime:0,prevPhase:S.None,running:!1,speed:1,cameraInitial:null,commentary:null,times:[],phaseLength:0,dimHighlightBlocks:null,markDirty:()=>{},phaseData:new Map,phaseTransitiveData:null,phaseList:[{groupId:k.Intro,title:"Introduction",phases:[{id:S.Intro_Intro,title:"Overview"},{id:S.Intro_Prelim,title:"Preliminary"}]},{groupId:k.Detailed_Input,title:"Detailed",phases:[{id:S.Input_Detail_Embedding,title:"Embedding"},{id:S.Input_Detail_LayerNorm,title:"Layer Norm"},{id:S.Input_Detail_SelfAttention,title:"Self Attention"},{id:S.Input_Detail_Projection,title:"Projection"},{id:S.Input_Detail_Mlp,title:"MLP"},{id:S.Input_Detail_Transformer,title:"Transformer"},{id:S.Input_Detail_Softmax,title:"Softmax"},{id:S.Input_Detail_Output,title:"Output"}]}]},h=ti.state,m={angle:null!==(n=null==h?void 0:h.camera.angle)&&void 0!==n?n:new K(296,16,13.5),center:null!==(r=null==h?void 0:h.camera.center)&&void 0!==r?r:new K(-8.4,0,-481.5),transition:{},modelMtx:new eT,viewMtx:new eT,lookAtMtx:new eT,camPos:new K,camPosModel:new K},p={B:1,T:11,C:48,nHeads:3,A:16,nBlocks:3,vocabSize:3};function x(e,t){return{center:e,angle:t}}let g=new K(1e4,0,0);return tG("A",[8]),tG("B",[7]),tG("Q",[2,2,2]),{einsumStates:t6,currentEinsumState:0,native:null,wasmGptModel:null,render:d,inWalkthrough:!0,walkthrough:f,camera:m,shape:p,layout:tO(p),currExampleId:-1,mainExample:{name:"nano-gpt",enabled:!0,shape:p,offset:new K,modelCardOffset:new K,blockRender:null,camera:x(new K(42.771,0,-569.287),new K(284.959,26.501,12.867))},examples:[{name:"GPT-2 (small)",enabled:!0,shape:{B:1,T:1024,C:768,nHeads:12,A:64,nBlocks:12,vocabSize:50257},offset:g.mul(-5),modelCardOffset:g.mul(-2),blockRender:tN(null!==(o=null==d?void 0:d.ctx)&&void 0!==o?o:null),camera:x(new K(-65141.321,0,-69843.439),new K(224.459,24.501,1574.24))},{name:"GPT-2 (XL)",enabled:!0,shape:{B:1,T:1024,C:1600,nHeads:25,A:64,nBlocks:48,vocabSize:50257},offset:g.mul(20),modelCardOffset:g.mul(.5),blockRender:tN(null!==(i=null==d?void 0:d.ctx)&&void 0!==i?i:null),camera:x(new K(237902.688,0,-47282.484),new K(311.959,23.501,1382.449))},{name:"GPT-3",enabled:!1,shape:{B:1,T:1024,C:12288,nHeads:96,A:128,nBlocks:96,vocabSize:50257},offset:g.mul(50),modelCardOffset:g.mul(15),blockRender:tN(null!==(a=null==d?void 0:d.ctx)&&void 0!==a?a:null),camera:x(new K(837678.163,0,-485242.286),new K(238.959,10.501,12583.939))}],gptGpuModel:null,jsGptModel:null,stepModel:!1,markDirty:()=>{},htmlSubs:new eU,mouse:{mousePos:new K},movement:{action:null,actionHover:null,target:[0,0],depth:1,cameraLerp:null},display:{tokenColors:null,tokenIdxColors:null,tokenOutputColors:null,lines:[],hoverTarget:null,dimHover:null,blkIdxHover:null},pageLayout:{height:0,width:0,isDesktop:!0,isPhone:!0}}}(e,n),this.progState.markDirty=this.markDirty,this.progState.walkthrough.markDirty=this.markDirty,this.renderState=this.progState.render,this.random=new eS(4),function(e){let t=e.layout.cubes,n=t[t.length-1],r=new K(n.x,n.y,n.z),o=e.camera.modelMtx.mul(eT.fromTranslation(e.mainExample.offset)).mulVec3Proj(r);e.camera.center=o,e.camera.angle=new K(270,4.5,.8)}(this.progState)}}},8248:function(e){e.exports={view:"LayerView_view__Tjb_T",sidebar:"LayerView_sidebar__rYQhV",canvasWrap:"LayerView_canvasWrap__Nz_uj",canvas:"LayerView_canvas__UYk4I",canvasEventSurface:"LayerView_canvasEventSurface__1KPkQ"}},2008:function(e){e.exports={split:"Sidebar_split___9RZf",walkthrough:"Sidebar_walkthrough__Gkr1T",timelineLeft:"Sidebar_timelineLeft__e8aE_",content:"Sidebar_content__M6iat",phaseGroupTitle:"Sidebar_phaseGroupTitle__Li2MO",phase:"Sidebar_phase__6CZQs",active:"Sidebar_active__5aKCi",phaseTitle:"Sidebar_phaseTitle__r6mbd",topSplit:"Sidebar_topSplit__cAaab",camStats:"Sidebar_camStats__l3zK5",title:"Sidebar_title__hqVHx",toc:"Sidebar_toc__ncbvo",helpers:"Sidebar_helpers__EJodm",popup:"Sidebar_popup__V9b4I",mainMenu:"Sidebar_mainMenu__jd7I1",menu:"Sidebar_menu__z2UJk",menuTopBar:"Sidebar_menuTopBar__PPm6Z"}}},function(e){e.O(0,[676,72,304,971,596,744],function(){return e(e.s=23720)}),_N_E=e.O()}]);
//# sourceMappingURL=page-28c10aca24a23eea.js.map